# Response to Google OAuth Verification Team
**Date:** November 25, 2025
**Project:** SaveMyAttachments (Project ID: savemyattachments)
**Project Number:** 811650947375

---

## EXECUTIVE SUMMARY

Thank you for your detailed review. We have addressed **ALL concerns** and implemented Google's recommended changes:

1. **DeepSeek Integration** - REMOVED. DeepSeek models are blocked at multiple levels in code.
2. **Scope Mismatch** - FIXED. appsscript.json now matches OAuth consent screen exactly.
3. **Drive Scope** - CHANGED to `drive.file` as recommended. Restructured app using Advanced Drive Service.
4. **Spreadsheets Scope** - CHANGED to `spreadsheets.currentonly` (Editor Add-on accesses only the active spreadsheet).

**Confirming narrower scopes** - We have successfully migrated to all recommended scopes.

---

## ISSUE 1: DeepSeek Integration - RESOLVED

### Action Taken: Complete Removal

DeepSeek models are **actively blocked** in the codebase. Users cannot select or use DeepSeek models.

**Implementation (OpenRouterService.gs lines 16-20):**
```javascript
function generateSummary(emailContent, apiKey, model, customPrompt) {
  // Filter out DeepSeek models for Google OAuth compliance
  if (model && model.toLowerCase().indexOf('deepseek') !== -1) {
    Logger.log('DeepSeek model blocked: ' + model);
    return '[Summary unavailable - DeepSeek models not supported]';
  }
  // ... rest of function
}
```

**Additional Protection (OpenRouterService.gs lines 145-149):**
```javascript
// Filter out DeepSeek models from model list
if (model.id && model.id.toLowerCase().indexOf('deepseek') !== -1) {
  Logger.log('Filtered out DeepSeek model: ' + model.id);
  return false; // Exclude from available models
}
```

**Result:** DeepSeek models are blocked at:
1. UI level - Not shown in model dropdown
2. API level - Filtered from model pricing/list
3. Runtime level - Blocked if manually specified

---

## ISSUE 2: Scope Mismatch - RESOLVED

### Action Taken: Updated appsscript.json

The `appsscript.json` manifest now declares the scopes we use:

```json
{
  "oauthScopes": [
    "https://www.googleapis.com/auth/gmail.readonly",
    "https://www.googleapis.com/auth/drive.file",
    "https://www.googleapis.com/auth/spreadsheets.currentonly",
    "https://www.googleapis.com/auth/script.external_request",
    "https://www.googleapis.com/auth/script.container.ui",
    "https://www.googleapis.com/auth/script.scriptapp"
  ]
}
```

**Verification:** Code pushed to production November 25, 2025.

---

## ISSUE 3: Drive Scope - RESOLVED

### Action Taken: Migrated to `drive.file` as Recommended

**Confirming narrower scopes** - We have successfully restructured our application to work with `drive.file`.

#### Technical Implementation:

As recommended in your email for Google Workspace Add-ons, we now use the **Advanced Drive Service** (Drive API v2) instead of DriveApp:

```javascript
// PickerHelper.gs - getOrCreateSaveFolder()
// Using Advanced Drive Service v2 for drive.file scope compatibility
function getOrCreateSaveFolder() {
  var folderMetadata = {
    title: 'SaveMyAttachments',
    mimeType: 'application/vnd.google-apps.folder'
  };

  // Drive.Files.insert() works with drive.file scope
  var folder = Drive.Files.insert(folderMetadata);

  // Save folder ID for future access
  userProperties.setProperty('DRIVE_FOLDER_ID', folder.id);
  return folder;
}
```

#### Changes Made:

1. **Switched from DriveApp to Advanced Drive Service** - As recommended for Workspace Add-ons
2. **Removed `DriveApp.getFoldersByName()`** - Required full `drive` scope
3. **Removed `DriveApp.getFolders()`** - Required full `drive` scope
4. **Implemented auto-create folder approach** - App creates dedicated "SaveMyAttachments" folder
5. **Use `Drive.Files.insert()` and `Drive.Files.get()`** - Compatible with `drive.file` scope

#### User Experience:

1. User clicks "Set Up Drive Folder" in Settings
2. App creates "SaveMyAttachments" folder in user's Drive root
3. User can move/rename folder afterward - app keeps ID reference
4. All files saved to this app-created folder

**Result:** Full `drive` scope is no longer required. `drive.file` is sufficient.

---

## ISSUE 4: Spreadsheets Scope - RESOLVED

### Action Taken: Migrated to `spreadsheets.currentonly`

**Confirming narrower scopes** - We have restructured our application to use the `spreadsheets.currentonly` scope.

#### Architecture Change:

**Before:** Could access any spreadsheet by URL using full `spreadsheets` scope
**After:** Editor Add-on that only accesses the active spreadsheet where user runs it

#### How It Works Now:

1. User installs SaveMyAttachments from Workspace Marketplace
2. User opens any Google Sheet and runs the add-on
3. Add-on can only access **that active spreadsheet** (not other spreadsheets)
4. Uses `spreadsheets.currentonly` scope (non-sensitive)

```javascript
// Config.gs - getCurrentSheet()
function getCurrentSheet() {
  return SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
}
```

**Result:** Full `spreadsheets` scope is no longer required. `spreadsheets.currentonly` is sufficient.

---

## FINAL SCOPE SUMMARY

| Scope | Type | Purpose |
|-------|------|---------|
| `gmail.readonly` | Sensitive | Read emails to process attachments |
| `drive.file` | **Non-sensitive** | Create folders and save files (app-created only) |
| `spreadsheets.currentonly` | **Non-sensitive** | Write to active spreadsheet only |
| `script.external_request` | Non-sensitive | Call OpenRouter API for AI summaries |
| `script.container.ui` | Non-sensitive | Display settings dialogs |
| `script.scriptapp` | Non-sensitive | Manage automation triggers |

**Key Benefits:**
- No restricted scopes required
- No CASA security assessment required
- Simpler OAuth verification process
- Better user privacy (minimal access)

---

## OAUTH CONSENT SCREEN - USER VIEW

When users authorize SaveMyAttachments, they see the following permissions on the OAuth consent screen:

| Permission Displayed | Scope | Justification |
|---------------------|-------|---------------|
| **"View your email messages and settings"** | `gmail.readonly` | Required to read emails and extract attachments for backup |
| **"See, edit, create, and delete only the specific Google Drive files you use with this app"** | `drive.file` | Required to create the SaveMyAttachments folder and save attachments. App can ONLY access files/folders it creates. |
| **"See, edit, create, and delete only the specific Google Sheets spreadsheet you use with this app"** | `spreadsheets.currentonly` | Required to log email metadata to the active spreadsheet. App can ONLY access the spreadsheet where it's running. |
| **"Connect to an external service"** | `script.external_request` | Required to call OpenRouter API for optional AI summarization (user provides their own API key) |
| **"Display and run third-party web content..."** | `script.container.ui` | Required to show settings panel and configuration dialogs |
| **"Allow this application to run when you are not present"** | `script.scriptapp` | Required for scheduled/automated email processing triggers |

**Note:** The exact wording may vary slightly based on Google's current consent screen formatting.

---

## DATA SEGREGATION ARCHITECTURE

SaveMyAttachments implements complete data segregation:

```
User's Google Workspace
├── Gmail (readonly) ──► App reads emails
├── Drive (app folder only) ──► App saves files
├── Sheets (active sheet only) ──► App logs metadata
│
└── User's OpenRouter Account
    ├── User's API key (stored in user's PropertiesService)
    ├── User's model selection (Claude, GPT-4, Gemini only - NO DeepSeek)
    └── AI processing (user pays, user controls)

Developer Access: ZERO
- No shared infrastructure
- No backend servers
- No cross-user data mixing
- No access to user API keys
```

---

## DEMO VIDEO

A new demo video is provided showing:

1. OAuth consent screen with scopes (gmail.readonly, drive.file, spreadsheets.currentonly, etc.)
2. Editor Add-on installation and first-run authorization
3. Auto-create folder setup using Advanced Drive Service (drive.file compatible)
4. Email processing flow
5. AI summarization (opt-in, user's API key)
6. DeepSeek model blocking demonstration

**Video link:** https://youtu.be/mUL0owqMxF4

---

## REPLY TO GOOGLE

**Regarding DeepSeek:** Integration removed. DeepSeek models are blocked at UI, API, and runtime levels. Users cannot use DeepSeek.

**Regarding Scope Mismatch:** Fixed. appsscript.json now matches Cloud Console exactly.

**Regarding Drive Scope:** Confirming narrower scopes. Successfully migrated to `drive.file` using Advanced Drive Service as recommended for Workspace Add-ons. App creates its own folder and only accesses app-created files.

**Regarding Spreadsheets Scope:** Confirming narrower scopes. Successfully migrated to `spreadsheets.currentonly`. As an Editor Add-on, the app only accesses the active spreadsheet where the user runs it.

**Demo video is attached.**

---

**Contact:** support@thecoralblock.com
**Privacy Policy:** https://thecoralblock.com/privacy.html
**Updated Code:** Pushed to production November 25, 2025
