================================================================================
SAVEME - ALL FILES FOR MANUAL COPY-PASTE
================================================================================

This file contains all 13 SaveMe files with clear separators.

HOW TO USE:
1. Open Apps Script editor (Extensions ‚Üí Apps Script)
2. For each file below:
   - Create new file (+ icon ‚Üí Script or HTML)
   - Copy content between the "START" and "END" markers
   - Paste into the Apps Script editor
   - Save

IMPORTANT:
- For .gs files: Click "+ ‚Üí Script"
- For .html files: Click "+ ‚Üí HTML"
- For appsscript.json: Enable in Project Settings first

================================================================================


================================================================================
FILE: Code.gs
TYPE: Script (.gs)
ACTION: In Apps Script, click '+ ‚Üí Script', name it 'Code.gs', paste content below
================================================================================

===== START OF Code.gs =====
/**
 * SaveMe - Gmail AI Assistant
 * Main entry point and menu setup
 */

/**
 * Creates custom menu when the add-on is installed or document is opened
 */
function onOpen() {
  var ui = SpreadsheetApp.getUi();
  ui.createMenu('SaveMe')
    .addItem('‚öôÔ∏è Configure Settings', 'showSettings')
    .addSeparator()
    .addItem('üìß Process New Emails Now', 'processNewEmailsManual')
    .addItem('üß™ Process Test Email', 'processTestEmail')
    .addSeparator()
    .addSubMenu(ui.createMenu('ü§ñ Automation')
      .addItem('Start Automation', 'startAutomationUI')
      .addItem('Stop Automation', 'stopAutomationUI')
      .addItem('View Status', 'showAutomationStatus'))
    .addSeparator()
    .addSubMenu(ui.createMenu('üìä Info & Monitoring')
      .addItem('View Diagnostics', 'showDiagnostics')
      .addItem('View Processed Count', 'showProcessedCount')
      .addItem('üí∞ View Cost Estimates', 'showCostEstimates'))
    .addSeparator()
    .addSubMenu(ui.createMenu('üîß Tools')
      .addItem('Create New Drive Folder', 'createNewFolder')
      .addItem('Test OpenRouter Connection', 'testOpenRouter')
      .addSeparator()
      .addItem('Clear Processed Tracking Only', 'clearProcessedUI')
      .addItem('Clear Everything & Start Fresh', 'clearEverythingUI')
      .addItem('üî• Nuclear Clear (Force Reset)', 'nuclearClearUI'))
    .addToUi();
}

/**
 * Manual trigger to process one test email
 * This is the main function to test the proof-of-concept
 */
function processTestEmail() {
  try {
    // Show processing message
    SpreadsheetApp.getActiveSpreadsheet().toast('Processing most recent email with attachment...', 'SaveMe', 5);

    // Get configuration
    var config = getConfig();

    // Validate configuration
    if (!config.apiKey) {
      SpreadsheetApp.getUi().alert('Error', 'OpenRouter API key not configured. Please run "Configure Settings" first.', SpreadsheetApp.getUi().ButtonSet.OK);
      return;
    }

    if (!config.folderId) {
      SpreadsheetApp.getUi().alert('Error', 'Drive folder not configured. Please run "Configure Settings" first.', SpreadsheetApp.getUi().ButtonSet.OK);
      return;
    }

    // Process the most recent email with attachment
    var result = processMostRecentEmail(config);

    if (result.success) {
      SpreadsheetApp.getUi().alert('Success!',
        'Email processed successfully!\n\n' +
        'Subject: ' + result.subject + '\n' +
        'Attachments saved: ' + result.attachmentCount + '\n' +
        'Summary: ' + result.summary.substring(0, 100) + '...',
        SpreadsheetApp.getUi().ButtonSet.OK);
    } else {
      SpreadsheetApp.getUi().alert('Error', result.error, SpreadsheetApp.getUi().ButtonSet.OK);
    }

  } catch (e) {
    Logger.log('Error in processTestEmail: ' + e.toString());
    SpreadsheetApp.getUi().alert('Error', 'Failed to process email: ' + e.message, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

/**
 * Show unified settings panel (new UI)
 */
function showSettings() {
  var html = HtmlService.createHtmlOutputFromFile('SettingsPanel')
    .setWidth(750)
    .setHeight(650)
    .setTitle('SaveMe Configuration');

  SpreadsheetApp.getUi().showModalDialog(html, 'SaveMe Configuration');
}

/**
 * Save all settings from the unified settings panel
 * Called from SettingsPanel.html
 */
function saveAllSettings(settings) {
  try {
    var userProperties = PropertiesService.getUserProperties();

    // Extract folder ID from URL if needed
    var folderId = extractIdFromUrl(settings.folderId);

    // Test folder access
    try {
      DriveApp.getFolderById(folderId);
    } catch (e) {
      throw new Error('Cannot access Drive folder. Please check the folder ID/URL.');
    }

    // Save all settings
    userProperties.setProperties({
      'OPENROUTER_API_KEY': settings.apiKey,
      'DRIVE_FOLDER_ID': folderId,

      // What to Save
      'SAVE_EMAIL_BODY': settings.saveEmailBody.toString(),
      'EMAIL_FORMAT': settings.emailFormat,
      'SAVE_ATTACHMENTS': settings.saveAttachments.toString(),

      // File Naming
      'FILE_NAMING_TEMPLATE': settings.fileNamingTemplate,
      'EMAIL_NAMING_TEMPLATE': settings.emailNamingTemplate,

      // File Filtering
      'MIN_ATTACHMENT_SIZE_KB': settings.minAttachmentSizeKB.toString(),
      'MAX_ATTACHMENT_SIZE_MB': settings.maxAttachmentSizeMB.toString(),
      'ALLOWED_EXTENSIONS': settings.allowedExtensions,
      'DISALLOWED_EXTENSIONS': settings.disallowedExtensions,

      // AI Settings
      'ENABLE_AI': settings.enableAI.toString(),
      'MODEL': settings.model,
      'SUMMARY_PROMPT': settings.summaryPrompt,
      'MAX_TOKENS': settings.maxTokens.toString(),

      // Processing Settings
      'BATCH_SIZE': settings.batchSize.toString(),
      'DAYS_BACK': settings.daysBack.toString(),
      'EMAIL_FILTER': settings.emailFilter,
      'NEWEST_FIRST': settings.newestFirst.toString()
    });

    Logger.log('All settings saved successfully');
    return { success: true };

  } catch (e) {
    Logger.log('Error saving settings: ' + e.toString());
    throw e;
  }
}

/**
 * Create a new SaveMe folder in Drive and configure it
 */
function createNewFolder() {
  var ui = SpreadsheetApp.getUi();

  var response = ui.alert(
    'Create SaveMe Folder',
    'Do you want to create a new "SaveMe Attachments" folder in your Drive?\n\n' +
    'This will be created in the root of "My Drive".',
    ui.ButtonSet.YES_NO
  );

  if (response == ui.Button.YES) {
    try {
      var folder = DriveApp.createFolder('SaveMe Attachments');
      var folderId = folder.getId();
      var folderUrl = folder.getUrl();

      saveConfig('DRIVE_FOLDER_ID', folderId);

      ui.alert('Success!',
        'Created folder successfully!\n\n' +
        'Folder: SaveMe Attachments\n' +
        'Location: My Drive\n\n' +
        'View it at: ' + folderUrl,
        ui.ButtonSet.OK);

    } catch (e) {
      ui.alert('Error', 'Failed to create folder: ' + e.message, ui.ButtonSet.OK);
    }
  }
}

/**
 * Test OpenRouter API connection
 */
function testOpenRouter() {
  try {
    var config = getConfig();

    if (!config.apiKey) {
      SpreadsheetApp.getUi().alert('Error', 'OpenRouter API key not configured. Please run "Configure Settings" first.', SpreadsheetApp.getUi().ButtonSet.OK);
      return;
    }

    SpreadsheetApp.getActiveSpreadsheet().toast('Testing OpenRouter connection...', 'SaveMe', 3);

    var testSummary = generateSummary('This is a test email about a project meeting scheduled for tomorrow at 2pm.', config.apiKey, 'anthropic/claude-3.5-sonnet');

    if (testSummary && !testSummary.startsWith('[Summary failed')) {
      SpreadsheetApp.getUi().alert('Success!',
        'OpenRouter API connection successful!\n\n' +
        'Test summary: ' + testSummary,
        SpreadsheetApp.getUi().ButtonSet.OK);
    } else {
      SpreadsheetApp.getUi().alert('Error',
        'OpenRouter API connection failed.\n\n' +
        'Response: ' + testSummary,
        SpreadsheetApp.getUi().ButtonSet.OK);
    }

  } catch (e) {
    Logger.log('Error testing OpenRouter: ' + e.toString());
    SpreadsheetApp.getUi().alert('Error', 'Failed to test OpenRouter: ' + e.message, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

/**
 * Process new emails manually (batch)
 */
function processNewEmailsManual() {
  var ui = SpreadsheetApp.getUi();
  var config = getConfig();

  if (!config.folderId) {
    ui.alert('Error', 'Drive folder not configured. Please run "Configure Settings" first.', ui.ButtonSet.OK);
    return;
  }

  SpreadsheetApp.getActiveSpreadsheet().toast('Processing new emails...', 'SaveMe', 5);

  try {
    var stats = processNewEmails(config);

    // Calculate cost estimate for this batch
    var modelPricing = {
      'anthropic/claude-3.5-sonnet': 3.00,
      'anthropic/claude-3-haiku': 0.25,
      'anthropic/claude-3-opus': 15.00,
      'openai/gpt-4-turbo': 10.00,
      'openai/gpt-3.5-turbo': 0.50,
      'mistralai/mistral-7b-instruct': 0.10
    };

    var pricePerMillion = modelPricing[config.model] || 1.00;
    var tokensPerEmail = 540; // Rough estimate
    var batchCost = (stats.processed * tokensPerEmail / 1000000) * pricePerMillion;

    var message = 'Processing complete!\n\n' +
                  'Found: ' + stats.found + ' emails\n' +
                  'Processed: ' + stats.processed + '\n' +
                  'Skipped (already processed): ' + stats.skipped + '\n' +
                  'Errors: ' + stats.errors;

    if (stats.processed > 0) {
      message += '\n\nüí∞ ESTIMATED COST:\n' +
                 '- This batch: $' + batchCost.toFixed(4) + '\n' +
                 '- Model: ' + config.model;
    }

    if (stats.errors > 0) {
      message += '\n\nError details:\n' + stats.errorMessages.join('\n');
    }

    message += '\n\nüí° Tip: View cost details in Tools ‚Üí View Cost Estimates';

    ui.alert('Batch Processing Results', message, ui.ButtonSet.OK);

  } catch (e) {
    Logger.log('Error in processNewEmailsManual: ' + e.toString());
    ui.alert('Error', 'Failed to process emails: ' + e.message, ui.ButtonSet.OK);
  }
}

/**
 * Start automation UI
 */
function startAutomationUI() {
  var ui = SpreadsheetApp.getUi();
  var config = getConfig();

  if (!config.folderId) {
    ui.alert('Error', 'Please configure settings first (Drive folder is required).', ui.ButtonSet.OK);
    return;
  }

  // Ask for interval
  var response = ui.prompt(
    'Start Automation',
    'How often should SaveMe check for new emails?\n\n' +
    'Enter number of minutes: 5, 10, 15, 30, or 60\n' +
    '(Recommended: 15)',
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() !== ui.Button.OK) {
    return;
  }

  var interval = parseInt(response.getResponseText());

  if ([5, 10, 15, 30, 60].indexOf(interval) === -1) {
    ui.alert('Error', 'Invalid interval. Please enter 5, 10, 15, 30, or 60.', ui.ButtonSet.OK);
    return;
  }

  try {
    setupAutomation(interval);
    ui.alert('Automation Started!',
      'SaveMe will now automatically check for new emails every ' + interval + ' minutes.\n\n' +
      'You can stop automation anytime from the Automation menu.',
      ui.ButtonSet.OK);
  } catch (e) {
    ui.alert('Error', 'Failed to start automation: ' + e.message, ui.ButtonSet.OK);
  }
}

/**
 * Stop automation UI
 */
function stopAutomationUI() {
  var ui = SpreadsheetApp.getUi();

  var response = ui.alert(
    'Stop Automation',
    'Are you sure you want to stop automatic email processing?',
    ui.ButtonSet.YES_NO
  );

  if (response === ui.Button.YES) {
    removeAllTriggers();
    ui.alert('Automation Stopped', 'Automatic processing has been disabled.', ui.ButtonSet.OK);
  }
}

/**
 * Show automation status
 */
function showAutomationStatus() {
  var ui = SpreadsheetApp.getUi();
  var status = getAutomationStatus();
  var processedCount = getProcessedCount();

  var message = 'Automation Status: ' + (status.enabled ? '‚úÖ ENABLED' : '‚ùå DISABLED') + '\n\n';

  if (status.enabled) {
    message += 'Interval: Every ' + status.interval + ' minutes\n';
    message += 'Last run: ' + (status.lastRun || 'Not yet run') + '\n\n';
  }

  message += 'Total emails processed: ' + processedCount;

  ui.alert('SaveMe Status', message, ui.ButtonSet.OK);
}

/**
 * Show processed email count
 */
function showProcessedCount() {
  var ui = SpreadsheetApp.getUi();
  var count = getProcessedCount();

  ui.alert('Processed Emails',
    'SaveMe has processed ' + count + ' emails so far.\n\n' +
    'These emails will be skipped in future processing runs.',
    ui.ButtonSet.OK);
}

/**
 * Show cost estimates for OpenRouter usage
 */
function showCostEstimates() {
  var ui = SpreadsheetApp.getUi();
  var config = getConfig();
  var processedCount = getProcessedCount();

  // Model pricing (approximate per 1M tokens)
  var modelPricing = {
    'anthropic/claude-3.5-sonnet': 3.00,
    'anthropic/claude-3-haiku': 0.25,
    'anthropic/claude-3-opus': 15.00,
    'openai/gpt-4-turbo': 10.00,
    'openai/gpt-4': 30.00,
    'openai/gpt-3.5-turbo': 0.50,
    'google/gemini-pro': 0.50,
    'meta-llama/llama-3-70b-instruct': 0.70,
    'meta-llama/llama-3.1-405b-instruct': 3.00,
    'mistralai/mistral-7b-instruct': 0.10,
    'mistralai/mixtral-8x7b-instruct': 0.50
  };

  // Get current model pricing
  var currentModel = config.model || 'anthropic/claude-3.5-sonnet';
  var pricePerMillion = modelPricing[currentModel] || 1.00; // Default if model not in list

  // Estimate tokens per email (rough average)
  // Email body ~500 tokens + prompt ~20 tokens + response ~20 tokens = ~540 tokens
  var tokensPerEmail = 540;

  // Calculate costs
  var tokensUsedSoFar = processedCount * tokensPerEmail;
  var costSoFar = (tokensUsedSoFar / 1000000) * pricePerMillion;

  // Future estimates
  var costPer100 = (100 * tokensPerEmail / 1000000) * pricePerMillion;
  var costPer1000 = (1000 * tokensPerEmail / 1000000) * pricePerMillion;
  var costPerMonth = (30 * config.batchSize * tokensPerEmail / 1000000) * pricePerMillion; // Assuming daily runs

  var message = 'üí∞ OPENROUTER COST ESTIMATES\n\n';

  message += 'üìä CURRENT STATUS:\n';
  message += '- Emails processed: ' + processedCount + '\n';
  message += '- Model: ' + currentModel + '\n';
  message += '- Price: $' + pricePerMillion.toFixed(2) + ' per 1M tokens\n';
  message += '- Estimated cost so far: $' + costSoFar.toFixed(4) + '\n\n';

  message += 'üíµ COST PROJECTIONS:\n';
  message += '- Per email: $' + (costPer100 / 100).toFixed(5) + '\n';
  message += '- Per 100 emails: $' + costPer100.toFixed(3) + '\n';
  message += '- Per 1000 emails: $' + costPer1000.toFixed(2) + '\n';
  message += '- Per month (daily batch): ~$' + costPerMonth.toFixed(2) + '\n\n';

  message += 'üí° COST COMPARISON (per 1000 emails):\n';
  message += '- Claude 3.5 Sonnet: $' + ((1000 * tokensPerEmail / 1000000) * 3.00).toFixed(2) + ' (best quality)\n';
  message += '- Claude 3 Haiku: $' + ((1000 * tokensPerEmail / 1000000) * 0.25).toFixed(2) + ' (good & fast)\n';
  message += '- GPT-3.5 Turbo: $' + ((1000 * tokensPerEmail / 1000000) * 0.50).toFixed(2) + ' (reliable)\n';
  message += '- Mistral 7B: $' + ((1000 * tokensPerEmail / 1000000) * 0.10).toFixed(2) + ' (cheapest)\n\n';

  message += 'üìà TO REDUCE COSTS:\n';
  message += '1. Switch to cheaper model (Haiku, Mistral)\n';
  message += '2. Shorten AI prompt\n';
  message += '3. Process less frequently\n';
  message += '4. Filter more emails\n\n';

  message += 'üîó Check actual usage:\n';
  message += 'https://openrouter.ai/dashboard';

  ui.alert('Cost Estimates', message, ui.ButtonSet.OK);
}

/**
 * Show diagnostic information
 */
function showDiagnostics() {
  var ui = SpreadsheetApp.getUi();
  var sheet = getCurrentSheet();

  // Check sheet state
  var lastRow = sheet.getLastRow();
  var messageIds = [];

  if (lastRow > 1) {
    var idsRange = sheet.getRange(2, 1, lastRow - 1, 1).getValues();
    messageIds = idsRange.map(function(row) { return row[0]; }).filter(function(id) { return id !== ''; });
  }

  // Check processed tracking (V2)
  var props = PropertiesService.getUserProperties();
  var processed = JSON.parse(props.getProperty('PROCESSED_MESSAGES_V2') || '[]');

  // Check tracked cache keys
  var trackedCacheKeys = JSON.parse(props.getProperty('CACHE_KEYS_V2') || '[]');

  // Get config settings
  var config = getConfig();

  var message = 'üìä DIAGNOSTICS\n\n';
  message += 'üìÑ SHEET STATE:\n';
  message += '- Total rows: ' + lastRow + '\n';
  message += '- Data rows: ' + (lastRow > 0 ? lastRow - 1 : 0) + '\n';
  message += '- Message IDs in sheet: ' + messageIds.length + '\n';
  message += '- First few IDs: ' + (messageIds.length > 0 ? messageIds.slice(0, 3).join(', ').substring(0, 50) : 'None') + '\n\n';

  message += 'üîç PROPERTIES STATE:\n';
  message += '- Processed emails tracked: ' + processed.length + '\n';
  message += '- Most recent: ' + (processed.length > 0 ? processed[processed.length - 1].subject : 'None') + '\n\n';

  message += 'üíæ CACHE STATE (V2 Tracked):\n';
  message += '- Tracked cache keys: ' + trackedCacheKeys.length + '\n';
  message += '- Sample keys: ' + (trackedCacheKeys.length > 0 ? trackedCacheKeys.slice(0, 2).join(', ').substring(0, 50) : 'None') + '\n\n';

  message += '‚öôÔ∏è CONFIGURATION:\n';
  message += '- Days back: ' + config.daysBack + ' days\n';
  message += '- Batch size: ' + config.batchSize + ' emails per run\n';
  message += '- Min attachment size: ' + config.minAttachmentSizeKB + ' KB\n';
  message += '- AI Model: ' + config.model + '\n';
  message += '- AI Prompt: ' + config.summaryPrompt.substring(0, 50) + '...\n';
  message += '- Process order: ' + (config.newestFirst ? 'Newest first' : 'Oldest first') + '\n\n';

  message += '‚ö†Ô∏è ALL SHOULD BE 0 after clearing:\n';
  message += '- Sheet rows: ' + lastRow + '\n';
  message += '- Properties tracked: ' + processed.length + '\n';
  message += '- Cache keys: ' + trackedCacheKeys.length;

  ui.alert('SaveMe Diagnostics', message, ui.ButtonSet.OK);
}

/**
 * Clear processed tracking UI
 */
function clearProcessedUI() {
  var ui = SpreadsheetApp.getUi();

  var response = ui.alert(
    'Clear Processed Tracking Only',
    'This will clear the tracking list only.\n\n' +
    'Note: Emails already in the Sheet will NOT be reprocessed\n' +
    '(to protect your edits).\n\n' +
    'To fully start fresh, use "Clear Everything & Start Fresh".\n\n' +
    'Continue?',
    ui.ButtonSet.YES_NO
  );

  if (response === ui.Button.YES) {
    clearProcessedEmails();
    ui.alert('Cleared',
      'Processed email tracking has been cleared.\n\n' +
      'Emails in the Sheet will still be skipped (to protect edits).',
      ui.ButtonSet.OK);
  }
}

/**
 * Clear everything and start fresh
 */
function clearEverythingUI() {
  var ui = SpreadsheetApp.getUi();

  var response = ui.alert(
    'Clear Everything & Start Fresh',
    '‚ö†Ô∏è WARNING: This will:\n\n' +
    '1. Delete ALL rows from the current sheet\n' +
    '2. Clear all processed email tracking\n\n' +
    'All emails will be reprocessed on the next run.\n\n' +
    'This CANNOT be undone!\n\n' +
    'Continue?',
    ui.ButtonSet.YES_NO
  );

  if (response === ui.Button.YES) {
    // Double confirmation
    var confirm = ui.alert(
      'Are you sure?',
      'This will permanently delete all rows in this sheet.\n\n' +
      'Are you absolutely sure?',
      ui.ButtonSet.YES_NO
    );

    if (confirm === ui.Button.YES) {
      var sheet = getCurrentSheet();

      Logger.log('Starting clear everything operation');
      Logger.log('Sheet last row before clear: ' + sheet.getLastRow());

      try {
        Logger.log('=== CLEAR EVERYTHING STARTING ===');

        // Clear the entire sheet (including headers - they'll be recreated)
        sheet.clear();
        Logger.log('Sheet cleared completely');

        // Clear processed tracking (now includes cache flush)
        var clearedCount = clearProcessedEmails();
        Logger.log('Cleared tracking for ' + clearedCount + ' emails (+ flushed cache)');

        // Verify it's actually clear
        var verifyLastRow = sheet.getLastRow();
        var verifyProps = PropertiesService.getUserProperties();
        var verifyProcessed = JSON.parse(verifyProps.getProperty('PROCESSED_MESSAGES_V2') || '[]');

        Logger.log('=== CLEAR EVERYTHING COMPLETE ===');
        Logger.log('Verification - Sheet rows: ' + verifyLastRow + ', Tracked (V2): ' + verifyProcessed.length);

        var message = '‚úÖ Everything Cleared!\n\n';
        message += 'Sheet rows: ' + verifyLastRow + '\n';
        message += 'Tracked emails: ' + verifyProcessed.length + '\n';
        message += 'Cache: FLUSHED\n\n';
        message += 'The sheet is now completely empty.\n';
        message += 'Run "Process New Emails Now" to start fresh.\n\n';
        message += 'If emails are still being skipped, use "Nuclear Clear".';

        ui.alert('Success', message, ui.ButtonSet.OK);

      } catch (e) {
        Logger.log('Error during clear: ' + e.toString());
        ui.alert('Error', 'Failed to clear: ' + e.message + '\n\nTry "Nuclear Clear" instead.', ui.ButtonSet.OK);
      }
    }
  }
}

/**
 * Nuclear clear - force reset everything
 */
function nuclearClearUI() {
  var ui = SpreadsheetApp.getUi();

  var response = ui.alert(
    'üî• Nuclear Clear (Force Reset)',
    '‚ö†Ô∏è EXTREME WARNING:\n\n' +
    'This will:\n' +
    '1. Delete ALL rows in the sheet\n' +
    '2. Flush ENTIRE user cache (all keys)\n' +
    '3. Delete ALL SaveMe properties\n\n' +
    'Use this ONLY if regular clear is not working.\n\n' +
    'This is the most aggressive reset possible.\n\n' +
    'Continue?',
    ui.ButtonSet.YES_NO
  );

  if (response === ui.Button.YES) {
    var confirm = ui.alert(
      'Final Confirmation',
      'Are you ABSOLUTELY SURE?\n\n' +
      'This will force-reset everything.',
      ui.ButtonSet.YES_NO
    );

    if (confirm === ui.Button.YES) {
      try {
        var sheet = getCurrentSheet();

        Logger.log('=== NUCLEAR CLEAR STARTING ===');

        // Clear sheet
        sheet.clear();
        Logger.log('Sheet cleared');

        // Nuclear clear of cache and properties
        var deletedProps = nuclearClearEverything();
        Logger.log('Deleted ' + deletedProps + ' properties and flushed cache');

        // Verify
        var verifyProps = PropertiesService.getUserProperties();
        var verifyProcessed = JSON.parse(verifyProps.getProperty('PROCESSED_MESSAGES_V2') || '[]');

        Logger.log('=== NUCLEAR CLEAR COMPLETE ===');
        Logger.log('Remaining tracked emails (V2): ' + verifyProcessed.length);

        var message = '‚úÖ Nuclear Clear Complete!\n\n';
        message += 'Sheet: CLEARED\n';
        message += 'Cache: FLUSHED\n';
        message += 'Properties deleted: ' + deletedProps + '\n';
        message += 'Tracked emails remaining: ' + verifyProcessed.length + '\n\n';
        message += 'Everything has been force-reset.\n\n';
        message += 'Try processing emails now.';

        ui.alert('Nuclear Clear Complete', message, ui.ButtonSet.OK);

      } catch (e) {
        Logger.log('Error during nuclear clear: ' + e.toString());
        ui.alert('Error', 'Nuclear clear failed: ' + e.message, ui.ButtonSet.OK);
      }
    }
  }
}

/**
 * Set batch size (number of emails to process per run)
 */
function setBatchSize() {
  var ui = SpreadsheetApp.getUi();
  var config = getConfig();

  var response = ui.prompt(
    'Batch Size',
    'How many emails should SaveMe process per run?\n\n' +
    'Current: ' + config.batchSize + ' emails\n\n' +
    'Enter a number between 1-50 (recommended: 10-20):',
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() === ui.Button.OK) {
    var size = parseInt(response.getResponseText());

    if (isNaN(size) || size < 1 || size > 50) {
      ui.alert('Error', 'Please enter a valid number between 1 and 50.', ui.ButtonSet.OK);
      return;
    }

    saveConfig('BATCH_SIZE', size.toString());
    ui.alert('Saved',
      'Batch size set to ' + size + ' emails per run.\n\n' +
      'SaveMe will now process up to ' + size + ' emails each time.',
      ui.ButtonSet.OK);
  }
}

/**
 * Set AI model for summaries
 */
function setAIModel() {
  var ui = SpreadsheetApp.getUi();
  var config = getConfig();

  var popularModels = [
    'anthropic/claude-3.5-sonnet (Best quality, ~$3/1M tokens)',
    'anthropic/claude-3-haiku (Fast & cheap, ~$0.25/1M tokens)',
    'openai/gpt-4-turbo (High quality, ~$10/1M tokens)',
    'openai/gpt-3.5-turbo (Cheap, ~$0.50/1M tokens)',
    'google/gemini-pro (Free tier available)',
    'meta-llama/llama-3-70b-instruct (Open source, ~$0.70/1M tokens)',
    'mistralai/mistral-7b-instruct (Very cheap, ~$0.10/1M tokens)'
  ];

  var modelList = popularModels.join('\n');

  var response = ui.prompt(
    'AI Model Selection',
    'Enter the OpenRouter model to use for summaries:\n\n' +
    'Current: ' + config.model + '\n\n' +
    'Popular options:\n' + modelList + '\n\n' +
    'Enter model name (e.g., anthropic/claude-3.5-sonnet):',
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() === ui.Button.OK) {
    var model = response.getResponseText().trim();

    if (!model) {
      ui.alert('Error', 'Please enter a valid model name.', ui.ButtonSet.OK);
      return;
    }

    saveConfig('MODEL', model);
    ui.alert('Saved',
      'AI model set to: ' + model + '\n\n' +
      'This model will be used for all email summaries.',
      ui.ButtonSet.OK);
  }
}

/**
 * Set custom AI prompt for summaries
 */
function setAIPrompt() {
  var ui = SpreadsheetApp.getUi();
  var config = getConfig();

  var currentPrompt = config.summaryPrompt || 'Summarize this email in 5-10 words, focusing on the main action or topic:';

  var examplePrompts = [
    '1. Summarize in 5-10 words (default)',
    '2. Extract action items from this email',
    '3. Is this email urgent? Why?',
    '4. What is the sender requesting?',
    '5. Extract key dates and deadlines',
    '6. Identify the main topic and sentiment'
  ];

  var response = ui.prompt(
    'AI Summary Prompt',
    'What question should the AI answer about each email?\n\n' +
    'Current prompt:\n' + currentPrompt + '\n\n' +
    'Examples:\n' + examplePrompts.join('\n') + '\n\n' +
    'Enter your custom prompt:',
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() === ui.Button.OK) {
    var prompt = response.getResponseText().trim();

    if (!prompt) {
      ui.alert('Error', 'Please enter a valid prompt.', ui.ButtonSet.OK);
      return;
    }

    saveConfig('SUMMARY_PROMPT', prompt);
    ui.alert('Saved',
      'AI prompt updated!\n\n' +
      'New prompt: ' + prompt.substring(0, 100) + (prompt.length > 100 ? '...' : ''),
      ui.ButtonSet.OK);
  }
}

/**
 * Set minimum attachment size filter
 */
function setMinAttachmentSize() {
  var ui = SpreadsheetApp.getUi();
  var config = getConfig();

  var response = ui.prompt(
    'Minimum Attachment Size',
    'Attachments smaller than this will be ignored (inline images, signatures, etc.)\n\n' +
    'Current: ' + config.minAttachmentSizeKB + ' KB\n\n' +
    'Enter new minimum size in KB (recommended: 3-10):',
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() === ui.Button.OK) {
    var sizeKB = parseInt(response.getResponseText());

    if (isNaN(sizeKB) || sizeKB < 0) {
      ui.alert('Error', 'Please enter a valid number.', ui.ButtonSet.OK);
      return;
    }

    saveConfig('MIN_ATTACHMENT_SIZE_KB', sizeKB.toString());
    ui.alert('Saved',
      'Minimum attachment size set to ' + sizeKB + ' KB.\n\n' +
      'Attachments smaller than this will not be saved to Drive.',
      ui.ButtonSet.OK);
  }
}

/**
 * Set how far back to search for emails
 */
function setDaysBack() {
  var ui = SpreadsheetApp.getUi();
  var config = getConfig();

  var response = ui.prompt(
    'Email Search Date Range',
    'How many days back should SaveMe search for emails?\n\n' +
    'Current: ' + config.daysBack + ' days\n\n' +
    'Enter number of days (7 = last week, 30 = last month, 90 = last 3 months, 365 = last year):',
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() === ui.Button.OK) {
    var days = parseInt(response.getResponseText());

    if (isNaN(days) || days < 1) {
      ui.alert('Error', 'Please enter a valid number (minimum 1 day).', ui.ButtonSet.OK);
      return;
    }

    if (days > 365) {
      var confirm = ui.alert(
        'Confirm Large Range',
        'You entered ' + days + ' days. This is more than a year.\n\n' +
        'Processing many old emails may take a long time.\n\n' +
        'Continue?',
        ui.ButtonSet.YES_NO
      );

      if (confirm !== ui.Button.YES) {
        return;
      }
    }

    saveConfig('DAYS_BACK', days.toString());
    ui.alert('Saved',
      'Date range set to ' + days + ' days back.\n\n' +
      'SaveMe will now search emails from the last ' + days + ' days.\n\n' +
      'Run "Process New Emails Now" to process older emails.',
      ui.ButtonSet.OK);
  }
}

===== END OF Code.gs =====


================================================================================
FILE: Config.gs
TYPE: Script (.gs)
ACTION: In Apps Script, click '+ ‚Üí Script', name it 'Config.gs', paste content below
================================================================================

===== START OF Config.gs =====
/**
 * Configuration Management
 * Stores and retrieves user settings using PropertiesService
 */

/**
 * Get current configuration
 */
function getConfig() {
  var userProperties = PropertiesService.getUserProperties();

  return {
    // Core settings
    apiKey: userProperties.getProperty('OPENROUTER_API_KEY'),
    model: userProperties.getProperty('MODEL') || 'anthropic/claude-3.5-sonnet',
    folderId: userProperties.getProperty('DRIVE_FOLDER_ID'),
    maxTokens: parseInt(userProperties.getProperty('MAX_TOKENS') || '100'),

    // What to Save (NEW)
    saveEmailBody: userProperties.getProperty('SAVE_EMAIL_BODY') === 'true',
    emailFormat: userProperties.getProperty('EMAIL_FORMAT') || 'pdf',
    saveAttachments: userProperties.getProperty('SAVE_ATTACHMENTS') !== 'false', // Default true

    // File Naming (NEW)
    fileNamingTemplate: userProperties.getProperty('FILE_NAMING_TEMPLATE') || '{{Year}}.{{Month}}.{{Day}}-{{AttachmentName}}',
    emailNamingTemplate: userProperties.getProperty('EMAIL_NAMING_TEMPLATE') || '{{Year}}-{{Month}}-{{Day}}_{{Subject}}',

    // File Filtering (NEW)
    maxAttachmentSizeMB: parseInt(userProperties.getProperty('MAX_ATTACHMENT_SIZE_MB') || '0'),
    allowedExtensions: userProperties.getProperty('ALLOWED_EXTENSIONS') || '',
    disallowedExtensions: userProperties.getProperty('DISALLOWED_EXTENSIONS') || '',

    // Automation settings
    automationEnabled: userProperties.getProperty('AUTOMATION_ENABLED') || 'false',
    automationInterval: userProperties.getProperty('AUTOMATION_INTERVAL') || '15',
    batchSize: parseInt(userProperties.getProperty('BATCH_SIZE') || '10'), // Default 10 emails per batch
    daysBack: parseInt(userProperties.getProperty('DAYS_BACK') || '7'),

    // AI settings
    enableAI: userProperties.getProperty('ENABLE_AI') !== 'false', // Default true
    summaryPrompt: userProperties.getProperty('SUMMARY_PROMPT') || 'Summarize this email in 5-10 words, focusing on the main action or topic:',
    newestFirst: userProperties.getProperty('NEWEST_FIRST') !== 'false', // Default true

    // Filtering settings
    emailFilter: userProperties.getProperty('EMAIL_FILTER') || '',
    senderFilter: userProperties.getProperty('SENDER_FILTER') || '',
    labelFilter: userProperties.getProperty('LABEL_FILTER') || '',
    minAttachmentSizeKB: parseInt(userProperties.getProperty('MIN_ATTACHMENT_SIZE_KB') || '5'),

    // Notification settings
    notifyOnErrors: userProperties.getProperty('NOTIFY_ON_ERRORS') || 'false',
    lastScheduledRun: userProperties.getProperty('LAST_SCHEDULED_RUN')
  };
}

/**
 * Save a configuration value
 */
function saveConfig(key, value) {
  var userProperties = PropertiesService.getUserProperties();
  userProperties.setProperty(key, value);
  Logger.log('Saved config: ' + key);
}

/**
 * Get the current spreadsheet (where results will be logged)
 */
function getCurrentSheet() {
  return SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
}

/**
 * Clear all configuration (useful for testing)
 */
function clearConfig() {
  PropertiesService.getUserProperties().deleteAllProperties();
  Logger.log('Configuration cleared');
}

===== END OF Config.gs =====


================================================================================
FILE: GmailProcessor.gs
TYPE: Script (.gs)
ACTION: In Apps Script, click '+ ‚Üí Script', name it 'GmailProcessor.gs', paste content below
================================================================================

===== START OF GmailProcessor.gs =====
/**
 * Gmail Processing
 * Fetches and processes emails from Gmail
 */

/**
 * Process new emails in batch (main automated function)
 *
 * @param {Object} config - Configuration object
 * @return {Object} Result object with stats
 */
function processNewEmails(config) {
  config = config || getConfig();

  var stats = {
    found: 0,
    processed: 0,
    skipped: 0,
    errors: 0,
    errorMessages: []
  };

  try {
    // Build search query
    var query = buildSearchQuery(config);
    Logger.log('Search query: ' + query);

    // Get emails (batch of 20 max per run)
    var maxEmails = config.batchSize || 20;
    var threads = GmailApp.search(query, 0, 50); // Get more threads but limit messages

    if (threads.length === 0) {
      Logger.log('‚ùå No new emails found matching criteria');
      Logger.log('   Search query was: ' + query);
      return stats;
    }

    Logger.log('‚úÖ Found ' + threads.length + ' thread(s) to check');
    Logger.log('   Batch limit: ' + maxEmails + ' emails');

    // Reverse threads to process newest first
    threads.reverse();
    Logger.log('   Processing order: Newest to oldest');

    var processedCount = 0;

    // Process each thread
    for (var i = 0; i < threads.length; i++) {
      // Stop if we've reached the batch limit
      if (processedCount >= maxEmails) {
        Logger.log('Reached batch limit of ' + maxEmails + ' emails, stopping');
        break;
      }

      var thread = threads[i];
      var messages = thread.getMessages();

      // Reverse messages within thread to process newest first
      messages.reverse();

      for (var j = 0; j < messages.length; j++) {
        // Stop if we've reached the batch limit
        if (processedCount >= maxEmails) {
          break;
        }

        var message = messages[j];
        var messageId = message.getId();

        stats.found++;

        Logger.log('Checking message: ' + messageId + ' - ' + message.getSubject());

        // Skip if already processed
        var isProcessed = isEmailProcessed(messageId);
        Logger.log('  isEmailProcessed() = ' + isProcessed);
        if (isProcessed) {
          Logger.log('  ‚ùå SKIPPING - Found in tracking (cache or properties)');
          stats.skipped++;
          continue;
        }

        // Skip if already in sheet (prevents overwriting edited rows)
        var isInSheet = isEmailInSheet(messageId);
        Logger.log('  isEmailInSheet() = ' + isInSheet);
        if (isInSheet) {
          Logger.log('  ‚ùå SKIPPING - Found in sheet');
          stats.skipped++;
          markEmailAsProcessed(messageId, message.getSubject()); // Mark as processed
          continue;
        }

        Logger.log('  ‚úÖ PROCESSING this email');

        try {
          // Mark as processed BEFORE processing (prevents duplicates)
          markEmailAsProcessed(messageId, message.getSubject());

          // Process the email
          var result = processEmail(message, config);

          if (result.success) {
            stats.processed++;
            processedCount++;
          } else {
            stats.errors++;
            stats.errorMessages.push(message.getSubject() + ': ' + result.error);
          }

        } catch (e) {
          Logger.log('Error processing message ' + messageId + ': ' + e.toString());
          stats.errors++;
          stats.errorMessages.push(message.getSubject() + ': ' + e.message);
        }
      }
    }

    Logger.log('=== PROCESSING COMPLETE ===');
    Logger.log('Found: ' + stats.found + ' emails in Gmail search');
    Logger.log('Processed: ' + stats.processed + ' emails');
    Logger.log('Skipped: ' + stats.skipped + ' emails (already processed or in sheet)');
    Logger.log('Errors: ' + stats.errors + ' emails');

    if (stats.found === 0) {
      Logger.log('‚ö†Ô∏è No emails found - check your Gmail search query and date range');
    } else if (stats.processed === 0 && stats.found > 0) {
      Logger.log('‚ö†Ô∏è Emails were found but none were processed - check logs above for skip reasons');
    }

    return stats;

  } catch (e) {
    Logger.log('Error in processNewEmails: ' + e.toString());
    stats.errors++;
    stats.errorMessages.push('Fatal error: ' + e.message);
    return stats;
  }
}

/**
 * Build Gmail search query from configuration
 *
 * @param {Object} config - Configuration object
 * @return {string} Gmail search query
 */
function buildSearchQuery(config) {
  var parts = [];

  // Custom filter from config (if provided)
  if (config.emailFilter) {
    parts.push(config.emailFilter);
  } else {
    // Default: has attachment
    parts.push('has:attachment');
  }

  // Date range filter
  var daysBack = config.daysBack || 7;
  parts.push('newer_than:' + daysBack + 'd');

  // Sender filter (if configured)
  if (config.senderFilter) {
    parts.push('from:' + config.senderFilter);
  }

  // Label filter (if configured)
  if (config.labelFilter) {
    parts.push('label:' + config.labelFilter);
  }

  // Exclude already processed (future: could use Gmail labels)
  // For now we rely on the tracking system

  return parts.join(' ');
}

/**
 * Process a single email message
 *
 * @param {GmailMessage} message - Gmail message object
 * @param {Object} config - Configuration object
 * @return {Object} Result object
 */
function processEmail(message, config) {
  try {
    Logger.log('Processing: ' + message.getSubject());

    var messageId = message.getId();

    // Extract email data
    var emailData = {
      date: message.getDate(),
      from: message.getFrom(),
      subject: message.getSubject(),
      body: message.getPlainBody().substring(0, 5000), // Limit to 5000 chars
      attachments: message.getAttachments()
    };

    var allSavedFiles = []; // Track all saved files (attachments + email body)

    // 1. SAVE EMAIL BODY (if enabled)
    if (config.saveEmailBody) {
      Logger.log('  üìß Saving email body as ' + config.emailFormat + '...');
      try {
        var emailBlobs = convertEmail(message, config.emailFormat);

        for (var i = 0; i < emailBlobs.length; i++) {
          var blob = emailBlobs[i];

          // Apply email naming template
          var fileName = applyEmailNamingTemplate(config.emailNamingTemplate, message, blob.getName().split('.').pop());
          blob.setName(fileName);

          // Save to Drive
          var folder = DriveApp.getFolderById(config.folderId);
          var file = folder.createFile(blob);

          allSavedFiles.push({
            name: file.getName(),
            url: file.getUrl(),
            type: 'email'
          });

          Logger.log('  ‚úÖ Saved email body: ' + file.getName());
        }
      } catch (e) {
        Logger.log('  ‚ö†Ô∏è Error saving email body: ' + e.toString());
        // Continue processing attachments even if email body fails
      }
    }

    // 2. SAVE ATTACHMENTS (if enabled)
    if (config.saveAttachments !== false) {
      // Filter attachments by size
      var filteredAttachments = filterAttachmentsBySize(emailData.attachments, config);
      Logger.log('  Total attachments: ' + emailData.attachments.length + ', After size filtering (>' + config.minAttachmentSizeKB + 'KB): ' + filteredAttachments.length);

      // Filter by extension
      filteredAttachments = filterAttachmentsByExtension(filteredAttachments, config);
      Logger.log('  After extension filtering: ' + filteredAttachments.length);

      // Save attachments
      if (filteredAttachments.length > 0) {
        var driveResult = saveAttachmentsToDrive(filteredAttachments, config, message);
        Logger.log('  üíæ Saved ' + driveResult.files.length + ' attachments');

        // Add to allSavedFiles
        for (var i = 0; i < driveResult.files.length; i++) {
          driveResult.files[i].type = 'attachment';
          allSavedFiles.push(driveResult.files[i]);
        }
      }
    }

    // Check if we saved anything
    if (allSavedFiles.length === 0) {
      Logger.log('  ‚ö†Ô∏è SKIPPING - No files saved (no attachments or email body)');
      return {
        success: false,
        error: 'No files saved after filtering'
      };
    }

    // 3. GENERATE AI SUMMARY (once for the email, if enabled)
    var summary = '';
    if (config.enableAI && config.apiKey && emailData.body && emailData.body.trim().length > 0) {
      Logger.log('  ü§ñ Generating AI summary...');
      summary = generateSummary(emailData.body, config.apiKey, config.model, config.summaryPrompt);
    } else {
      if (!config.enableAI) {
        Logger.log('  ‚ö†Ô∏è AI summary disabled in settings');
      } else if (!config.apiKey) {
        Logger.log('  ‚ö†Ô∏è No API key configured');
      } else if (!emailData.body || emailData.body.trim().length === 0) {
        Logger.log('  ‚ö†Ô∏è Email has no body, skipping AI summary');
      }
    }

    // 4. ADD ROWS TO SHEET (one row per saved file)
    for (var i = 0; i < allSavedFiles.length; i++) {
      var file = allSavedFiles[i];

      addToSheet({
        messageId: messageId,
        timestamp: emailData.date,
        sender: emailData.from,
        subject: emailData.subject,
        summary: summary,
        attachmentName: file.name,
        attachmentUrl: file.url
      });

      Logger.log('  ‚úÖ Added row for: ' + file.name + ' (' + file.type + ')');
    }

    return {
      success: true,
      subject: emailData.subject,
      summary: summary,
      filesaved: allSavedFiles.length
    };

  } catch (e) {
    Logger.log('Error processing email: ' + e.toString());
    return {
      success: false,
      error: e.message
    };
  }
}

/**
 * Filter attachments by minimum size to exclude inline images, signatures, etc.
 *
 * @param {Array} attachments - Array of GmailAttachment objects
 * @param {Object} config - Configuration object
 * @return {Array} Filtered attachments
 */
function filterAttachmentsBySize(attachments, config) {
  if (!attachments || attachments.length === 0) {
    return [];
  }

  // Get minimum size in KB (default 5 KB)
  var minSizeKB = config.minAttachmentSizeKB || 5;
  var minSizeBytes = minSizeKB * 1024;

  var filtered = [];

  for (var i = 0; i < attachments.length; i++) {
    var attachment = attachments[i];
    var size = attachment.getSize();

    if (size >= minSizeBytes) {
      filtered.push(attachment);
      Logger.log('Keeping attachment: ' + attachment.getName() + ' (' + Math.round(size/1024) + ' KB)');
    } else {
      Logger.log('Filtering out small attachment: ' + attachment.getName() + ' (' + Math.round(size/1024) + ' KB)');
    }
  }

  return filtered;
}

/**
 * Filter attachments by file extension
 *
 * @param {Array} attachments - Array of GmailAttachment objects
 * @param {Object} config - Configuration object
 * @return {Array} Filtered attachments
 */
function filterAttachmentsByExtension(attachments, config) {
  if (!attachments || attachments.length === 0) {
    return [];
  }

  // If no extension filtering is configured, return all
  if (!config.allowedExtensions && !config.disallowedExtensions) {
    return attachments;
  }

  var filtered = [];

  for (var i = 0; i < attachments.length; i++) {
    var attachment = attachments[i];
    var fileName = attachment.getName();

    if (isExtensionAllowed(fileName, config.allowedExtensions, config.disallowedExtensions)) {
      filtered.push(attachment);
    }
  }

  return filtered;
}

/**
 * Process the most recent email (for manual testing)
 * This is kept for backward compatibility with the test button
 *
 * @param {Object} config - Configuration object
 * @return {Object} Result object
 */
function processMostRecentEmail(config) {
  try {
    var query = buildSearchQuery(config);
    var threads = GmailApp.search(query, 0, 1);

    if (threads.length === 0) {
      return {
        success: false,
        error: 'No emails found matching your filters in the last ' + (config.daysBack || 7) + ' days.'
      };
    }

    var messages = threads[0].getMessages();
    var message = messages[messages.length - 1];

    Logger.log('Processing most recent: ' + message.getSubject());

    var result = processEmail(message, config);

    if (result.success) {
      markEmailAsProcessed(message.getId(), message.getSubject());
      result.attachmentCount = message.getAttachments().length;
      result.subject = message.getSubject();
    }

    return result;

  } catch (e) {
    Logger.log('Error in processMostRecentEmail: ' + e.toString());
    return {
      success: false,
      error: e.message
    };
  }
}

/**
 * Extract sender email from "Name <email@domain.com>" format
 */
function extractEmail(fromString) {
  var match = fromString.match(/<(.+?)>/);
  return match ? match[1] : fromString;
}

/**
 * Extract sender name from "Name <email@domain.com>" format
 */
function extractName(fromString) {
  var match = fromString.match(/^(.+?)\s*</);
  return match ? match[1].trim().replace(/["']/g, '') : fromString;
}

===== END OF GmailProcessor.gs =====


================================================================================
FILE: DriveManager.gs
TYPE: Script (.gs)
ACTION: In Apps Script, click '+ ‚Üí Script', name it 'DriveManager.gs', paste content below
================================================================================

===== START OF DriveManager.gs =====
/**
 * Google Drive Management
 * Handles file upload and folder organization
 */

/**
 * Save email attachments to Google Drive with file naming templates
 *
 * @param {Array} attachments - Array of GmailAttachment objects
 * @param {Object} config - Configuration object (includes folderId and fileNamingTemplate)
 * @param {GmailMessage} message - Gmail message object (optional, for template variables)
 * @return {Object} Object with urls array and files array (name + url)
 */
function saveAttachmentsToDrive(attachments, config, message) {
  // Support legacy calls with just folderId
  var folderId = (typeof config === 'string') ? config : config.folderId;
  var useTemplates = (typeof config === 'object') && config.fileNamingTemplate && message;

  var folder;

  try {
    folder = DriveApp.getFolderById(folderId);
  } catch (e) {
    Logger.log('Error accessing Drive folder: ' + e.toString());
    throw new Error('Cannot access Drive folder. Please check the folder ID in settings.');
  }

  var links = [];
  var filesInfo = [];

  for (var i = 0; i < attachments.length; i++) {
    var attachment = attachments[i];
    try {
      var originalFileName = attachment.getName();
      var blob = attachment.copyBlob();

      Logger.log('Saving attachment: ' + originalFileName);

      // Apply file naming template if configured
      var fileName = originalFileName;
      if (useTemplates) {
        fileName = applyFileNamingTemplate(config.fileNamingTemplate, message, originalFileName);
        Logger.log('Applied template, new name: ' + fileName);
      }

      // Check for duplicate names and add timestamp if needed
      var existingFiles = folder.getFilesByName(fileName);
      if (existingFiles.hasNext()) {
        fileName = addTimestampToFileName(fileName);
        Logger.log('Duplicate found, renamed to: ' + fileName);
      }

      // Create the file in Drive
      var file = folder.createFile(blob.setName(fileName));
      var fileUrl = file.getUrl();
      links.push(fileUrl);
      filesInfo.push({
        name: fileName,
        url: fileUrl
      });

      Logger.log('Saved: ' + fileName + ' -> ' + fileUrl);

    } catch (e) {
      Logger.log('Error saving attachment ' + attachment.getName() + ': ' + e.toString());
      var errorMsg = '[Error saving ' + attachment.getName() + ']';
      links.push(errorMsg);
      filesInfo.push({
        name: errorMsg,
        url: ''
      });
    }
  }

  return {
    urls: links,
    files: filesInfo
  };
}

/**
 * Add timestamp to filename to avoid duplicates
 *
 * @param {string} fileName - Original filename
 * @return {string} Filename with timestamp
 */
function addTimestampToFileName(fileName) {
  var parts = fileName.split('.');
  var extension = parts.length > 1 ? parts.pop() : '';
  var name = parts.join('.');

  var timestamp = Utilities.formatDate(
    new Date(),
    Session.getScriptTimeZone(),
    'yyyyMMdd_HHmmss'
  );

  return name + '_' + timestamp + (extension ? '.' + extension : '');
}

/**
 * Extract Drive folder/file ID from URL
 *
 * @param {string} url - Google Drive URL
 * @return {string} Extracted ID
 */
function extractIdFromUrl(url) {
  var match = url.match(/[-\w]{25,}/);
  return match ? match[0] : url;
}

/**
 * Create a new folder in Drive (for future use)
 *
 * @param {string} parentFolderId - Parent folder ID
 * @param {string} folderName - Name of new folder
 * @return {Folder} Created folder object
 */
function createFolder(parentFolderId, folderName) {
  var parentFolder = DriveApp.getFolderById(parentFolderId);
  return parentFolder.createFolder(folderName);
}

===== END OF DriveManager.gs =====


================================================================================
FILE: EmailConverter.gs
TYPE: Script (.gs)
ACTION: In Apps Script, click '+ ‚Üí Script', name it 'EmailConverter.gs', paste content below
================================================================================

===== START OF EmailConverter.gs =====
/**
 * Email Converter
 * Converts email messages to various formats (PDF, HTML, Plain Text)
 */

/**
 * Convert email message to specified format(s)
 *
 * @param {GmailMessage} message - Gmail message object
 * @param {string} format - Format to convert to: 'pdf', 'html', 'txt', or 'all'
 * @return {Array} Array of blob objects with converted files
 */
function convertEmail(message, format) {
  var blobs = [];

  try {
    if (format === 'all') {
      // Convert to all formats
      blobs.push(convertEmailToPDF(message));
      blobs.push(convertEmailToHTML(message));
      blobs.push(convertEmailToPlainText(message));
    } else if (format === 'pdf') {
      blobs.push(convertEmailToPDF(message));
    } else if (format === 'html') {
      blobs.push(convertEmailToHTML(message));
    } else if (format === 'txt') {
      blobs.push(convertEmailToPlainText(message));
    } else {
      // Default to PDF
      blobs.push(convertEmailToPDF(message));
    }

    return blobs;

  } catch (e) {
    Logger.log('Error converting email: ' + e.toString());
    throw e;
  }
}

/**
 * Convert email to PDF format
 * Uses Google Drive's PDF conversion capability
 *
 * @param {GmailMessage} message - Gmail message object
 * @return {Blob} PDF blob
 */
function convertEmailToPDF(message) {
  try {
    // Build HTML representation
    var html = buildEmailHTML(message);

    // Create a temporary Google Doc from HTML
    var tempDoc = DriveApp.createFile(
      'temp_email_' + message.getId(),
      html,
      MimeType.HTML
    );

    // Convert to PDF
    var pdfBlob = tempDoc.getAs(MimeType.PDF);

    // Clean up temp file
    tempDoc.setTrashed(true);

    // Set proper filename (will be applied by calling function)
    pdfBlob.setName('email.pdf');

    Logger.log('‚úÖ Converted email to PDF');
    return pdfBlob;

  } catch (e) {
    Logger.log('Error converting email to PDF: ' + e.toString());
    throw new Error('Failed to convert email to PDF: ' + e.message);
  }
}

/**
 * Convert email to HTML format
 *
 * @param {GmailMessage} message - Gmail message object
 * @return {Blob} HTML blob
 */
function convertEmailToHTML(message) {
  try {
    var html = buildEmailHTML(message);
    var blob = Utilities.newBlob(html, MimeType.HTML, 'email.html');

    Logger.log('‚úÖ Converted email to HTML');
    return blob;

  } catch (e) {
    Logger.log('Error converting email to HTML: ' + e.toString());
    throw new Error('Failed to convert email to HTML: ' + e.message);
  }
}

/**
 * Convert email to plain text format
 *
 * @param {GmailMessage} message - Gmail message object
 * @return {Blob} Plain text blob
 */
function convertEmailToPlainText(message) {
  try {
    var text = '';

    // Header information
    text += 'From: ' + message.getFrom() + '\n';
    text += 'To: ' + message.getTo() + '\n';

    var cc = message.getCc();
    if (cc) {
      text += 'CC: ' + cc + '\n';
    }

    text += 'Date: ' + Utilities.formatDate(message.getDate(), Session.getScriptTimeZone(), 'yyyy-MM-dd HH:mm:ss') + '\n';
    text += 'Subject: ' + message.getSubject() + '\n';

    // Attachments info
    var attachments = message.getAttachments();
    if (attachments.length > 0) {
      text += 'Attachments: ' + attachments.length + ' file(s)\n';
      attachments.forEach(function(att) {
        text += '  - ' + att.getName() + ' (' + formatFileSize(att.getSize()) + ')\n';
      });
    }

    text += '\n' + '='.repeat(70) + '\n\n';

    // Email body
    text += message.getPlainBody();

    var blob = Utilities.newBlob(text, MimeType.PLAIN_TEXT, 'email.txt');

    Logger.log('‚úÖ Converted email to Plain Text');
    return blob;

  } catch (e) {
    Logger.log('Error converting email to Plain Text: ' + e.toString());
    throw new Error('Failed to convert email to Plain Text: ' + e.message);
  }
}

/**
 * Build HTML representation of email
 * Creates a nicely formatted HTML version of the email
 *
 * @param {GmailMessage} message - Gmail message object
 * @return {string} HTML string
 */
function buildEmailHTML(message) {
  var html = '<!DOCTYPE html>\n<html>\n<head>\n';
  html += '<meta charset="UTF-8">\n';
  html += '<title>' + escapeHtml(message.getSubject()) + '</title>\n';
  html += '<style>\n';
  html += 'body { font-family: Arial, Helvetica, sans-serif; padding: 20px; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; }\n';
  html += '.email-header { background: #f5f5f5; padding: 20px; margin-bottom: 20px; border-radius: 5px; border-left: 4px solid #1a73e8; }\n';
  html += '.header-row { margin-bottom: 8px; }\n';
  html += '.header-label { font-weight: bold; color: #555; display: inline-block; width: 80px; }\n';
  html += '.header-value { color: #333; }\n';
  html += '.email-body { padding: 20px; background: white; border: 1px solid #ddd; border-radius: 5px; }\n';
  html += '.attachments { margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 5px; }\n';
  html += '.attachments h3 { margin-top: 0; color: #555; font-size: 14px; }\n';
  html += '.attachment-item { padding: 8px; background: white; margin: 5px 0; border-radius: 3px; border: 1px solid #e0e0e0; }\n';
  html += '</style>\n';
  html += '</head>\n<body>\n';

  // Email header section
  html += '<div class="email-header">\n';
  html += '<div class="header-row"><span class="header-label">From:</span> <span class="header-value">' + escapeHtml(message.getFrom()) + '</span></div>\n';
  html += '<div class="header-row"><span class="header-label">To:</span> <span class="header-value">' + escapeHtml(message.getTo()) + '</span></div>\n';

  var cc = message.getCc();
  if (cc) {
    html += '<div class="header-row"><span class="header-label">CC:</span> <span class="header-value">' + escapeHtml(cc) + '</span></div>\n';
  }

  var date = Utilities.formatDate(message.getDate(), Session.getScriptTimeZone(), 'EEEE, MMMM dd, yyyy \'at\' HH:mm:ss');
  html += '<div class="header-row"><span class="header-label">Date:</span> <span class="header-value">' + date + '</span></div>\n';
  html += '<div class="header-row"><span class="header-label">Subject:</span> <span class="header-value"><strong>' + escapeHtml(message.getSubject()) + '</strong></span></div>\n';

  html += '</div>\n';

  // Attachments info (if any)
  var attachments = message.getAttachments();
  if (attachments.length > 0) {
    html += '<div class="attachments">\n';
    html += '<h3>üìé Attachments (' + attachments.length + '):</h3>\n';
    attachments.forEach(function(att) {
      html += '<div class="attachment-item">üìÑ ' + escapeHtml(att.getName()) + ' (' + formatFileSize(att.getSize()) + ')</div>\n';
    });
    html += '</div>\n';
  }

  // Email body
  html += '<div class="email-body">\n';

  // Try to get HTML body first, fall back to plain text
  try {
    var bodyHtml = message.getBody();
    if (bodyHtml) {
      html += bodyHtml;
    } else {
      // Fallback to plain text with line breaks
      html += '<pre style="white-space: pre-wrap; font-family: inherit;">' + escapeHtml(message.getPlainBody()) + '</pre>\n';
    }
  } catch (e) {
    // If HTML body fails, use plain text
    html += '<pre style="white-space: pre-wrap; font-family: inherit;">' + escapeHtml(message.getPlainBody()) + '</pre>\n';
  }

  html += '</div>\n';

  html += '</body>\n</html>';

  return html;
}

/**
 * Escape HTML special characters
 *
 * @param {string} text - Text to escape
 * @return {string} Escaped text
 */
function escapeHtml(text) {
  if (!text) return '';

  return text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

/**
 * Format file size in human-readable format
 *
 * @param {number} bytes - Size in bytes
 * @return {string} Formatted size
 */
function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';

  var k = 1024;
  var sizes = ['Bytes', 'KB', 'MB', 'GB'];
  var i = Math.floor(Math.log(bytes) / Math.log(k));

  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

/**
 * Test function for email conversion
 */
function testEmailConversion() {
  var threads = GmailApp.search('has:attachment', 0, 1);
  if (threads.length === 0) {
    Logger.log('No emails found for testing');
    return;
  }

  var message = threads[0].getMessages()[0];

  Logger.log('=== Email Conversion Test ===');
  Logger.log('Email: ' + message.getSubject());
  Logger.log('From: ' + message.getFrom());
  Logger.log('');

  // Test all formats
  try {
    Logger.log('Testing PDF conversion...');
    var pdfBlob = convertEmailToPDF(message);
    Logger.log('‚úÖ PDF: ' + pdfBlob.getName() + ' (' + formatFileSize(pdfBlob.getBytes().length) + ')');

    Logger.log('Testing HTML conversion...');
    var htmlBlob = convertEmailToHTML(message);
    Logger.log('‚úÖ HTML: ' + htmlBlob.getName() + ' (' + formatFileSize(htmlBlob.getBytes().length) + ')');

    Logger.log('Testing Plain Text conversion...');
    var txtBlob = convertEmailToPlainText(message);
    Logger.log('‚úÖ TXT: ' + txtBlob.getName() + ' (' + formatFileSize(txtBlob.getBytes().length) + ')');

    Logger.log('');
    Logger.log('All conversions successful!');

  } catch (e) {
    Logger.log('‚ùå Error during conversion: ' + e.toString());
  }
}

===== END OF EmailConverter.gs =====


================================================================================
FILE: FileNaming.gs
TYPE: Script (.gs)
ACTION: In Apps Script, click '+ ‚Üí Script', name it 'FileNaming.gs', paste content below
================================================================================

===== START OF FileNaming.gs =====
/**
 * File Naming Template Engine
 * Applies custom naming templates to files using variable substitution
 */

/**
 * Apply file naming template to attachment
 *
 * @param {string} template - Template string with {{Variable}} placeholders
 * @param {GmailMessage} message - Gmail message object
 * @param {string} originalFileName - Original attachment filename
 * @return {string} Processed filename
 */
function applyFileNamingTemplate(template, message, originalFileName) {
  if (!template) {
    return originalFileName; // Fallback to original name
  }

  var fileName = template;
  var date = message.getDate();
  var timeZone = Session.getScriptTimeZone();

  // Date/Time variables
  fileName = fileName.replace(/\{\{Year\}\}/g, Utilities.formatDate(date, timeZone, 'yyyy'));
  fileName = fileName.replace(/\{\{Month\}\}/g, Utilities.formatDate(date, timeZone, 'MM'));
  fileName = fileName.replace(/\{\{MonthName\}\}/g, Utilities.formatDate(date, timeZone, 'MMMM'));
  fileName = fileName.replace(/\{\{MonthShort\}\}/g, Utilities.formatDate(date, timeZone, 'MMM'));
  fileName = fileName.replace(/\{\{Day\}\}/g, Utilities.formatDate(date, timeZone, 'dd'));
  fileName = fileName.replace(/\{\{Date\}\}/g, Utilities.formatDate(date, timeZone, 'yyyy-MM-dd'));
  fileName = fileName.replace(/\{\{DateTime\}\}/g, Utilities.formatDate(date, timeZone, 'yyyy-MM-dd_HHmmss'));
  fileName = fileName.replace(/\{\{Time\}\}/g, Utilities.formatDate(date, timeZone, 'HHmmss'));
  fileName = fileName.replace(/\{\{Hour\}\}/g, Utilities.formatDate(date, timeZone, 'HH'));
  fileName = fileName.replace(/\{\{Minute\}\}/g, Utilities.formatDate(date, timeZone, 'mm'));
  fileName = fileName.replace(/\{\{Second\}\}/g, Utilities.formatDate(date, timeZone, 'ss'));

  // Sender variables
  var from = message.getFrom();
  var senderEmail = extractEmail(from);
  var senderName = extractName(from);

  fileName = fileName.replace(/\{\{Sender\}\}/g, sanitizeFileName(senderName));
  fileName = fileName.replace(/\{\{SenderEmail\}\}/g, sanitizeFileName(senderEmail));
  fileName = fileName.replace(/\{\{SenderDomain\}\}/g, sanitizeFileName(senderEmail.split('@')[1] || senderEmail));

  // Subject variable
  var subject = message.getSubject() || 'No Subject';
  fileName = fileName.replace(/\{\{Subject\}\}/g, sanitizeFileName(subject));

  // Attachment variables
  if (originalFileName) {
    var fileNameWithoutExt = originalFileName.replace(/\.[^.]+$/, '');
    var extension = originalFileName.split('.').pop().toLowerCase();

    fileName = fileName.replace(/\{\{AttachmentName\}\}/g, sanitizeFileName(fileNameWithoutExt));
    fileName = fileName.replace(/\{\{OriginalName\}\}/g, sanitizeFileName(originalFileName));
    fileName = fileName.replace(/\{\{Extension\}\}/g, extension);

    // Add extension if not present in template
    if (!fileName.match(/\.[a-zA-Z0-9]+$/)) {
      fileName += '.' + extension;
    }
  }

  // Message ID (for uniqueness)
  var messageId = message.getId().substring(0, 8);
  fileName = fileName.replace(/\{\{MessageID\}\}/g, messageId);

  // Clean up any remaining unreplaced variables
  fileName = fileName.replace(/\{\{[^}]+\}\}/g, '');

  // Limit filename length (max 255 chars for most filesystems)
  if (fileName.length > 200) {
    var parts = fileName.split('.');
    var ext = parts.pop();
    var name = parts.join('.');
    fileName = name.substring(0, 200 - ext.length - 1) + '.' + ext;
  }

  return fileName;
}

/**
 * Apply email body naming template
 *
 * @param {string} template - Template string with {{Variable}} placeholders
 * @param {GmailMessage} message - Gmail message object
 * @param {string} format - File format (pdf, html, txt)
 * @return {string} Processed filename
 */
function applyEmailNamingTemplate(template, message, format) {
  if (!template) {
    // Default: Subject_Date.format
    var subject = sanitizeFileName(message.getSubject() || 'Email');
    var date = Utilities.formatDate(message.getDate(), Session.getScriptTimeZone(), 'yyyy-MM-dd');
    return subject + '_' + date + '.' + format;
  }

  // Use same logic as attachment naming, but no original filename
  var fileName = applyFileNamingTemplate(template, message, null);

  // Add format extension if not present
  if (!fileName.match(/\.[a-zA-Z0-9]+$/)) {
    fileName += '.' + format;
  } else {
    // Replace extension with format
    fileName = fileName.replace(/\.[a-zA-Z0-9]+$/, '.' + format);
  }

  return fileName;
}

/**
 * Sanitize filename to remove invalid characters
 *
 * @param {string} name - Filename to sanitize
 * @return {string} Sanitized filename
 */
function sanitizeFileName(name) {
  if (!name) return 'unnamed';

  // Remove or replace invalid characters for filenames
  // Invalid: / \ : * ? " < > |
  var sanitized = name
    .replace(/[\/\\:*?"<>|]/g, '_')  // Replace invalid chars with underscore
    .replace(/\s+/g, '_')            // Replace spaces with underscore
    .replace(/_+/g, '_')             // Collapse multiple underscores
    .replace(/^_+|_+$/g, '')         // Trim underscores from ends
    .substring(0, 150);              // Limit length

  return sanitized || 'unnamed';
}

/**
 * Parse file extension filtering settings
 *
 * @param {string} extensionsString - Comma-separated list of extensions
 * @return {Array} Array of lowercase extensions without dots
 */
function parseExtensions(extensionsString) {
  if (!extensionsString || extensionsString.trim() === '') {
    return [];
  }

  return extensionsString
    .split(',')
    .map(function(ext) {
      return ext.trim().toLowerCase().replace(/^\./, ''); // Remove leading dot if present
    })
    .filter(function(ext) {
      return ext.length > 0;
    });
}

/**
 * Check if file extension is allowed based on filtering rules
 *
 * @param {string} fileName - Filename to check
 * @param {string} allowedExtensions - Comma-separated allowed extensions
 * @param {string} disallowedExtensions - Comma-separated disallowed extensions
 * @return {boolean} True if file is allowed
 */
function isExtensionAllowed(fileName, allowedExtensions, disallowedExtensions) {
  var extension = fileName.split('.').pop().toLowerCase();

  // Parse extension lists
  var allowed = parseExtensions(allowedExtensions);
  var disallowed = parseExtensions(disallowedExtensions);

  // If disallow list exists and includes this extension, reject
  if (disallowed.length > 0 && disallowed.indexOf(extension) >= 0) {
    Logger.log('File rejected by disallow list: ' + fileName + ' (.' + extension + ')');
    return false;
  }

  // If allow list exists, only accept if extension is in it
  if (allowed.length > 0) {
    var isAllowed = allowed.indexOf(extension) >= 0;
    if (!isAllowed) {
      Logger.log('File rejected by allow list: ' + fileName + ' (.' + extension + ')');
    }
    return isAllowed;
  }

  // No restrictions, allow all
  return true;
}

/**
 * Test function for file naming
 */
function testFileNaming() {
  // Create a mock message for testing
  var threads = GmailApp.search('has:attachment', 0, 1);
  if (threads.length === 0) {
    Logger.log('No emails found for testing');
    return;
  }

  var message = threads[0].getMessages()[0];

  // Test various templates
  var templates = [
    '{{Year}}.{{Month}}.{{Day}}-{{AttachmentName}}',
    '{{Date}}_{{Sender}}_{{Subject}}',
    '{{Year}}/{{Month}}/{{AttachmentName}}',
    '{{DateTime}}_{{Subject}}',
    '{{Sender}}_{{Date}}'
  ];

  Logger.log('=== File Naming Template Tests ===');
  Logger.log('Email: ' + message.getSubject());
  Logger.log('From: ' + message.getFrom());
  Logger.log('');

  templates.forEach(function(template) {
    var result = applyFileNamingTemplate(template, message, 'invoice.pdf');
    Logger.log('Template: ' + template);
    Logger.log('Result: ' + result);
    Logger.log('');
  });
}

===== END OF FileNaming.gs =====


================================================================================
FILE: OpenRouterService.gs
TYPE: Script (.gs)
ACTION: In Apps Script, click '+ ‚Üí Script', name it 'OpenRouterService.gs', paste content below
================================================================================

===== START OF OpenRouterService.gs =====
/**
 * OpenRouter API Integration
 * Handles AI summarization via OpenRouter.ai
 */

/**
 * Generate an AI summary of email content
 *
 * @param {string} emailContent - The email body text to summarize
 * @param {string} apiKey - OpenRouter API key
 * @param {string} model - Model to use (default: anthropic/claude-3.5-sonnet)
 * @param {string} customPrompt - Optional custom prompt
 * @return {string} AI-generated summary
 */
function generateSummary(emailContent, apiKey, model, customPrompt) {
  var url = 'https://openrouter.ai/api/v1/chat/completions';

  var prompt = customPrompt || 'Summarize this email in 5-10 words, focusing on the main action or topic:';

  var payload = {
    model: model || 'anthropic/claude-3.5-sonnet',
    messages: [
      {
        role: "user",
        content: prompt + "\n\n" + emailContent
      }
    ],
    max_tokens: 100,
    temperature: 0.3
  };

  var options = {
    method: 'post',
    contentType: 'application/json',
    headers: {
      'Authorization': 'Bearer ' + apiKey,
      'HTTP-Referer': 'https://saveme-gmail-assistant.com',
      'X-Title': 'SaveMe Gmail AI Assistant'
    },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };

  try {
    Logger.log('Calling OpenRouter API...');
    var response = UrlFetchApp.fetch(url, options);
    var responseCode = response.getResponseCode();

    Logger.log('OpenRouter response code: ' + responseCode);

    if (responseCode !== 200) {
      var errorText = response.getContentText();
      Logger.log('OpenRouter API Error: ' + errorText);
      return '[Summary failed - API Error: ' + responseCode + ']';
    }

    var result = JSON.parse(response.getContentText());
    var summary = result.choices[0].message.content.trim();

    Logger.log('Summary generated: ' + summary);
    return summary;

  } catch (e) {
    Logger.log('OpenRouter API Exception: ' + e.toString());
    return '[Summary failed - ' + e.message + ']';
  }
}

/**
 * Get list of available models from OpenRouter
 * (For future use in model selector UI)
 */
function fetchAvailableModels() {
  var url = 'https://openrouter.ai/api/v1/models';

  try {
    var response = UrlFetchApp.fetch(url);
    return JSON.parse(response.getContentText()).data;
  } catch (e) {
    Logger.log('Error fetching models: ' + e.toString());
    return [];
  }
}

===== END OF OpenRouterService.gs =====


================================================================================
FILE: EmailTracker.gs
TYPE: Script (.gs)
ACTION: In Apps Script, click '+ ‚Üí Script', name it 'EmailTracker.gs', paste content below
================================================================================

===== START OF EmailTracker.gs =====
/**
 * Email Processing Tracker
 * Keeps track of which emails have been processed to avoid duplicates
 */

/**
 * Check if an email has already been processed
 *
 * @param {string} messageId - Gmail message ID
 * @return {boolean} True if already processed
 */
function isEmailProcessed(messageId) {
  // Use v2 cache key to avoid old orphaned entries
  var cacheKeyPrefix = 'processed_v2_';

  // Check cache first (fast)
  var cache = CacheService.getUserCache();
  var cacheValue = cache.get(cacheKeyPrefix + messageId);
  if (cacheValue !== null) {
    Logger.log('Found in cache: ' + messageId);
    return true;
  }

  // Check properties (persistent) - use V2 to ignore old entries
  var props = PropertiesService.getUserProperties();
  var processed = JSON.parse(props.getProperty('PROCESSED_MESSAGES_V2') || '[]');

  var found = processed.some(function(item) {
    return item.id === messageId;
  });

  if (found) {
    Logger.log('Found in properties V2: ' + messageId);
  }

  return found;
}

/**
 * Mark an email as processed
 *
 * @param {string} messageId - Gmail message ID
 * @param {string} subject - Email subject (for logging)
 */
function markEmailAsProcessed(messageId, subject) {
  // Use v2 cache key to avoid old orphaned entries
  var cacheKeyPrefix = 'processed_v2_';
  var cache = CacheService.getUserCache();
  var cacheKey = cacheKeyPrefix + messageId;
  cache.put(cacheKey, 'true', 21600);

  // Track this cache key so we can delete it later
  var props = PropertiesService.getUserProperties();
  var cacheKeys = JSON.parse(props.getProperty('CACHE_KEYS_V2') || '[]');
  if (cacheKeys.indexOf(cacheKey) === -1) {
    cacheKeys.push(cacheKey);
    // Keep only last 1000 keys
    if (cacheKeys.length > 1000) {
      cacheKeys = cacheKeys.slice(-1000);
    }
    props.setProperty('CACHE_KEYS_V2', JSON.stringify(cacheKeys));
  }

  // Add to properties (persistent) - use V2 to start fresh
  var processed = JSON.parse(props.getProperty('PROCESSED_MESSAGES_V2') || '[]');

  processed.push({
    id: messageId,
    subject: subject,
    date: Date.now()
  });

  // Keep only last 1000 messages (prevent property size limits)
  if (processed.length > 1000) {
    processed = processed.slice(-1000);
  }

  props.setProperty('PROCESSED_MESSAGES_V2', JSON.stringify(processed));

  Logger.log('Marked as processed V2: ' + messageId + ' - ' + subject);
}

/**
 * Get count of processed emails
 *
 * @return {number} Number of processed emails
 */
function getProcessedCount() {
  var props = PropertiesService.getUserProperties();
  var processed = JSON.parse(props.getProperty('PROCESSED_MESSAGES_V2') || '[]');
  return processed.length;
}

/**
 * Clear all processed email tracking
 * Useful for testing or starting fresh
 */
function clearProcessedEmails() {
  var props = PropertiesService.getUserProperties();
  var cache = CacheService.getUserCache();

  Logger.log('Starting clear processed emails');

  // Get tracked cache keys (v2)
  var cacheKeys = JSON.parse(props.getProperty('CACHE_KEYS_V2') || '[]');
  Logger.log('Found ' + cacheKeys.length + ' tracked cache keys');

  // Clear cache using tracked keys
  if (cacheKeys.length > 0) {
    cache.removeAll(cacheKeys);
    Logger.log('Cleared ' + cacheKeys.length + ' cache entries');
  }

  // Get processed count before deleting
  var processed = JSON.parse(props.getProperty('PROCESSED_MESSAGES_V2') || '[]');
  var clearedCount = processed.length;
  Logger.log('Clearing ' + clearedCount + ' processed email entries from tracking');

  // Delete properties (both V1 and V2)
  props.deleteProperty('PROCESSED_MESSAGES');    // Old V1
  props.deleteProperty('PROCESSED_MESSAGES_V2'); // New V2
  props.deleteProperty('CACHE_KEYS_V2');
  props.deleteProperty('CACHE_KEYS'); // Old version
  Logger.log('Cleared all PROCESSED_MESSAGES and CACHE_KEYS properties');

  Logger.log('‚úì Cleared all processed email tracking (both Properties and Cache)');

  return clearedCount;
}

/**
 * Nuclear option: Clear ALL cache and properties
 * Use this if regular clearing doesn't work
 */
function nuclearClearEverything() {
  var props = PropertiesService.getUserProperties();
  var cache = CacheService.getUserCache();

  Logger.log('üî• NUCLEAR CLEAR: Removing ALL cache and SaveMe properties');

  // Flush entire cache
  try {
    var keys = cache.getKeys();
    if (keys && keys.length > 0) {
      cache.removeAll(keys);
      Logger.log('Removed ' + keys.length + ' cache keys');
    }
  } catch (e) {
    Logger.log('Cache clear error: ' + e.toString());
  }

  // Delete all SaveMe-related properties
  var allProps = props.getProperties();
  var deletedCount = 0;
  for (var key in allProps) {
    if (key.indexOf('PROCESSED') !== -1 || key.indexOf('CACHE_KEYS') !== -1 || key.indexOf('SaveMe') !== -1) {
      props.deleteProperty(key);
      deletedCount++;
      Logger.log('Deleted property: ' + key);
    }
  }

  Logger.log('Deleted ' + deletedCount + ' properties total');
  Logger.log('‚úì Nuclear clear complete');

  return deletedCount;
}

/**
 * Get list of recently processed emails
 *
 * @param {number} limit - Number of recent emails to return (default: 10)
 * @return {Array} Array of processed email objects
 */
function getRecentlyProcessed(limit) {
  limit = limit || 10;

  var props = PropertiesService.getUserProperties();
  var processed = JSON.parse(props.getProperty('PROCESSED_MESSAGES_V2') || '[]');

  // Sort by date descending and return latest
  processed.sort(function(a, b) {
    return b.date - a.date;
  });

  return processed.slice(0, limit);
}

===== END OF EmailTracker.gs =====


================================================================================
FILE: SheetsManager.gs
TYPE: Script (.gs)
ACTION: In Apps Script, click '+ ‚Üí Script', name it 'SheetsManager.gs', paste content below
================================================================================

===== START OF SheetsManager.gs =====
/**
 * Google Sheets Management
 * Handles spreadsheet logging and data organization
 */

/**
 * Add email data to the current spreadsheet
 * Each row represents ONE attachment from an email
 *
 * @param {Object} data - Email data object with timestamp, sender, subject, etc.
 */
function addToSheet(data) {
  var sheet = getCurrentSheet();

  // Ensure headers exist (with Message ID as first hidden column)
  if (sheet.getLastRow() === 0) {
    var headers = ['Message ID', 'Date', 'Sender', 'Subject', 'Attachment', 'AI Summary'];
    sheet.appendRow(headers);

    // Format header row
    var headerRange = sheet.getRange(1, 1, 1, headers.length);
    headerRange.setFontWeight('bold');
    headerRange.setBackground('#4285f4');
    headerRange.setFontColor('#ffffff');

    // Hide Message ID column
    sheet.hideColumns(1);

    // Freeze header row
    sheet.setFrozenRows(1);

    Logger.log('Created header row (AI Summary is now last column)');
  }

  // Add data row (one row per attachment)
  // NEW ORDER: Message ID, Date, Sender, Subject, Attachment, AI Summary
  var rowData = [
    data.messageId || '',
    data.timestamp,
    data.sender,
    data.subject,
    '', // Attachment link (added below with formula)
    data.summary || '' // AI Summary (last column, may be empty)
  ];

  // Insert at row 2 (after headers) to keep newest at top
  // Or use appendRow() to add at bottom
  var config = getConfig();
  var insertAtTop = config.newestFirst || true; // Default to newest first

  var targetRow;
  if (insertAtTop && sheet.getLastRow() > 0) {
    // Insert after header row
    sheet.insertRowAfter(1);
    targetRow = 2;
    sheet.getRange(targetRow, 1, 1, rowData.length).setValues([rowData]);
  } else {
    // Append at bottom (original behavior)
    sheet.appendRow(rowData);
    targetRow = sheet.getLastRow();
  }

  var lastRow = targetRow;

  // Format the date column (column 2)
  sheet.getRange(lastRow, 2).setNumberFormat('yyyy-mm-dd hh:mm:ss');

  // Add attachment as clickable link (column 5 - moved before AI Summary)
  if (data.attachmentName && data.attachmentUrl) {
    var attachmentCell = sheet.getRange(lastRow, 5);

    // Use HYPERLINK formula for clean clickable filename
    attachmentCell.setFormula('=HYPERLINK("' + data.attachmentUrl + '", "' + data.attachmentName + '")');
  }

  // Auto-resize columns for better readability
  sheet.autoResizeColumns(2, 6);

  Logger.log('Added row ' + lastRow + ' for attachment: ' + data.attachmentName);
}

/**
 * Check if an email is already in the sheet (by message ID)
 *
 * @param {string} messageId - Gmail message ID
 * @return {boolean} True if email is already in sheet
 */
function isEmailInSheet(messageId) {
  var sheet = getCurrentSheet();

  // If no data yet, return false
  if (sheet.getLastRow() <= 1) {
    return false;
  }

  // Get all message IDs from column 1
  var messageIds = sheet.getRange(2, 1, sheet.getLastRow() - 1, 1).getValues();

  // Check if this message ID exists
  for (var i = 0; i < messageIds.length; i++) {
    if (messageIds[i][0] === messageId) {
      return true;
    }
  }

  return false;
}

/**
 * Clear all data from the sheet (keeping headers)
 * Useful for testing
 */
function clearSheetData() {
  var sheet = getCurrentSheet();

  if (sheet.getLastRow() > 1) {
    sheet.deleteRows(2, sheet.getLastRow() - 1);
    Logger.log('Cleared sheet data');
  }
}

/**
 * Create a new sheet for SaveMe data
 * (For future use when working with specific sheets)
 */
function createSaveMeSheet() {
  var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = spreadsheet.insertSheet('SaveMe Emails');

  // Add headers
  var headers = ['Date', 'Sender', 'Subject', 'AI Summary', 'Attachments', 'Drive Links'];
  sheet.appendRow(headers);

  // Format header
  var headerRange = sheet.getRange(1, 1, 1, headers.length);
  headerRange.setFontWeight('bold');
  headerRange.setBackground('#4285f4');
  headerRange.setFontColor('#ffffff');

  sheet.setFrozenRows(1);
  sheet.autoResizeColumns(1, 6);

  Logger.log('Created SaveMe sheet');
  return sheet;
}

===== END OF SheetsManager.gs =====


================================================================================
FILE: TriggerManager.gs
TYPE: Script (.gs)
ACTION: In Apps Script, click '+ ‚Üí Script', name it 'TriggerManager.gs', paste content below
================================================================================

===== START OF TriggerManager.gs =====
/**
 * Trigger Management
 * Handles scheduled automation of email processing
 */

/**
 * Set up automatic email processing trigger
 *
 * @param {number} intervalMinutes - How often to run (5, 10, 15, 30, or 60)
 */
function setupAutomation(intervalMinutes) {
  // Remove any existing SaveMe triggers first
  removeAllTriggers();

  // Validate interval
  var validIntervals = [5, 10, 15, 30, 60];
  if (validIntervals.indexOf(intervalMinutes) === -1) {
    throw new Error('Invalid interval. Must be 5, 10, 15, 30, or 60 minutes.');
  }

  // Create new time-based trigger
  var trigger = ScriptApp.newTrigger('runScheduledProcessing')
    .timeBased()
    .everyMinutes(intervalMinutes)
    .create();

  // Save the trigger settings
  saveConfig('AUTOMATION_ENABLED', 'true');
  saveConfig('AUTOMATION_INTERVAL', intervalMinutes.toString());

  Logger.log('Automation enabled: every ' + intervalMinutes + ' minutes');

  return {
    enabled: true,
    interval: intervalMinutes,
    triggerId: trigger.getUniqueId()
  };
}

/**
 * This is the function that runs automatically on schedule
 * It's called by the time-based trigger
 */
function runScheduledProcessing() {
  Logger.log('===== Scheduled processing started =====');

  try {
    var config = getConfig();

    // Check if automation is still enabled
    if (config.automationEnabled !== 'true') {
      Logger.log('Automation is disabled, skipping');
      return;
    }

    // Process new emails
    var stats = processNewEmails(config);

    Logger.log('Scheduled processing complete:');
    Logger.log('- Found: ' + stats.found);
    Logger.log('- Processed: ' + stats.processed);
    Logger.log('- Skipped: ' + stats.skipped);
    Logger.log('- Errors: ' + stats.errors);

    // Send notification email if there were errors (optional)
    if (stats.errors > 0 && config.notifyOnErrors === 'true') {
      sendErrorNotification(stats);
    }

  } catch (e) {
    Logger.log('Error in scheduled processing: ' + e.toString());

    // Log to a special error sheet (optional)
    logScheduledError(e);
  }

  Logger.log('===== Scheduled processing finished =====');
}

/**
 * Remove all SaveMe automation triggers
 */
function removeAllTriggers() {
  var triggers = ScriptApp.getProjectTriggers();

  triggers.forEach(function(trigger) {
    // Only remove triggers for runScheduledProcessing
    if (trigger.getHandlerFunction() === 'runScheduledProcessing') {
      ScriptApp.deleteTrigger(trigger);
      Logger.log('Deleted trigger: ' + trigger.getUniqueId());
    }
  });

  saveConfig('AUTOMATION_ENABLED', 'false');
  Logger.log('All automation triggers removed');
}

/**
 * Check if automation is currently enabled
 *
 * @return {Object} Status object with enabled and interval
 */
function getAutomationStatus() {
  var config = getConfig();
  var triggers = ScriptApp.getProjectTriggers();

  var activeTriggers = triggers.filter(function(trigger) {
    return trigger.getHandlerFunction() === 'runScheduledProcessing';
  });

  return {
    enabled: config.automationEnabled === 'true' && activeTriggers.length > 0,
    interval: parseInt(config.automationInterval || '15'),
    triggerCount: activeTriggers.length,
    lastRun: config.lastScheduledRun || 'Never'
  };
}

/**
 * Send error notification email
 *
 * @param {Object} stats - Processing statistics
 */
function sendErrorNotification(stats) {
  try {
    var userEmail = Session.getActiveUser().getEmail();

    var subject = 'SaveMe: Processing Errors (' + stats.errors + ' errors)';

    var body = 'SaveMe encountered errors during scheduled processing:\n\n';
    body += 'Processed: ' + stats.processed + '\n';
    body += 'Errors: ' + stats.errors + '\n\n';
    body += 'Error details:\n';

    stats.errorMessages.forEach(function(msg) {
      body += '- ' + msg + '\n';
    });

    body += '\n\nPlease check your Google Apps Script logs for more details.';

    GmailApp.sendEmail(userEmail, subject, body);
    Logger.log('Sent error notification to: ' + userEmail);

  } catch (e) {
    Logger.log('Failed to send error notification: ' + e.toString());
  }
}

/**
 * Log scheduled processing errors
 *
 * @param {Error} error - The error object
 */
function logScheduledError(error) {
  try {
    var sheet = getCurrentSheet();

    // Add error row with special formatting
    sheet.appendRow([
      new Date(),
      '[SYSTEM ERROR]',
      'Scheduled Processing Failed',
      error.message,
      0,
      ''
    ]);

    var lastRow = sheet.getLastRow();
    sheet.getRange(lastRow, 1, 1, 6).setBackground('#ffebee');

  } catch (e) {
    Logger.log('Failed to log error to sheet: ' + e.toString());
  }
}

===== END OF TriggerManager.gs =====


================================================================================
FILE: DebugManager.gs
TYPE: Script (.gs)
ACTION: In Apps Script, click '+ ‚Üí Script', name it 'DebugManager.gs', paste content below
================================================================================

===== START OF DebugManager.gs =====
/**
 * Debug Manager
 * Tools for diagnosing why emails aren't being processed
 */

/**
 * Show exactly what Gmail search is being used
 */
function showSearchQuery() {
  var ui = SpreadsheetApp.getUi();
  var config = getConfig();

  var query = buildSearchQuery(config);

  var message = 'üîç GMAIL SEARCH DETAILS\n\n';
  message += 'üìù FULL SEARCH QUERY:\n';
  message += query + '\n\n';

  message += '‚öôÔ∏è QUERY COMPONENTS:\n';
  message += '- Base: has:attachment\n';
  message += '- Date range: newer_than:' + config.daysBack + 'd\n';

  if (config.emailFilter) {
    message += '- Custom filter: ' + config.emailFilter + '\n';
  }
  if (config.senderFilter) {
    message += '- Sender filter: from:' + config.senderFilter + '\n';
  }
  if (config.labelFilter) {
    message += '- Label filter: label:' + config.labelFilter + '\n';
  }

  message += '\nüìä SEARCH SETTINGS:\n';
  message += '- Days back: ' + config.daysBack + '\n';
  message += '- Batch size: ' + config.batchSize + '\n';
  message += '- Min attachment size: ' + config.minAttachmentSizeKB + ' KB\n\n';

  message += 'üí° TO TEST THIS QUERY:\n';
  message += '1. Copy the full query above\n';
  message += '2. Paste it in Gmail search box\n';
  message += '3. See what emails it finds';

  ui.alert('Gmail Search Query', message, ui.ButtonSet.OK);
}

/**
 * Test if a specific email would be processed
 */
function testSpecificEmail() {
  var ui = SpreadsheetApp.getUi();

  var response = ui.prompt(
    'Test Specific Email',
    'Enter a subject line of an email you expect to be processed:',
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() !== ui.Button.OK) {
    return;
  }

  var searchSubject = response.getResponseText();
  var config = getConfig();

  Logger.log('=== TESTING SPECIFIC EMAIL ===');
  Logger.log('Looking for: ' + searchSubject);

  // Search for this specific email
  var query = 'subject:"' + searchSubject + '" has:attachment';
  Logger.log('Test query: ' + query);

  var threads = GmailApp.search(query, 0, 1);

  if (threads.length === 0) {
    ui.alert('Not Found',
      'Email not found with query:\n' + query + '\n\n' +
      'This email either:\n' +
      '1. Doesn\'t exist\n' +
      '2. Has no attachments\n' +
      '3. Is in Trash/Spam',
      ui.ButtonSet.OK);
    return;
  }

  var message = threads[0].getMessages()[0];
  var messageId = message.getId();

  // Check all the conditions
  var results = 'üìß EMAIL FOUND\n\n';
  results += 'Subject: ' + message.getSubject() + '\n';
  results += 'From: ' + message.getFrom() + '\n';
  results += 'Date: ' + message.getDate() + '\n';
  results += 'Message ID: ' + messageId + '\n\n';

  // Check if processed
  var isProcessed = isEmailProcessed(messageId);
  results += 'üîç PROCESSING CHECKS:\n';
  results += '- Is processed (cache/props): ' + (isProcessed ? '‚ùå YES (will skip)' : '‚úÖ NO') + '\n';

  var isInSheet = isEmailInSheet(messageId);
  results += '- Is in sheet: ' + (isInSheet ? '‚ùå YES (will skip)' : '‚úÖ NO') + '\n';

  // Check attachments
  var attachments = message.getAttachments();
  results += '\nüìé ATTACHMENTS:\n';
  results += '- Total count: ' + attachments.length + '\n';

  if (attachments.length > 0) {
    for (var i = 0; i < Math.min(3, attachments.length); i++) {
      var att = attachments[i];
      var sizeKB = Math.round(att.getSize() / 1024);
      var willKeep = sizeKB >= config.minAttachmentSizeKB;
      results += '- ' + att.getName() + ' (' + sizeKB + ' KB) - ' +
                 (willKeep ? '‚úÖ Will keep' : '‚ùå Too small') + '\n';
    }
  }

  // Check if it matches current search
  var currentQuery = buildSearchQuery(config);
  var matchesQuery = GmailApp.search(currentQuery + ' rfc822msgid:' + messageId, 0, 1).length > 0;

  results += '\nüìã MATCHES CURRENT SEARCH:\n';
  results += matchesQuery ? '‚úÖ YES - Would be found' : '‚ùå NO - Would NOT be found';

  if (!matchesQuery) {
    results += '\n\nCurrent search query:\n' + currentQuery;
    results += '\n\nThis email doesn\'t match because it\'s either:\n';
    results += '- Older than ' + config.daysBack + ' days\n';
    results += '- Doesn\'t match filters';
  }

  ui.alert('Email Test Results', results, ui.ButtonSet.OK);
}

/**
 * List all properties and their values
 */
function showAllProperties() {
  var ui = SpreadsheetApp.getUi();
  var props = PropertiesService.getUserProperties();
  var allProps = props.getProperties();

  var message = 'üì¶ ALL USER PROPERTIES\n\n';

  var count = 0;
  for (var key in allProps) {
    count++;
    var value = allProps[key];

    // Truncate long values
    if (value.length > 100) {
      value = value.substring(0, 100) + '... [' + value.length + ' chars]';
    }

    message += key + ':\n' + value + '\n\n';

    if (count >= 10) {
      message += '... and ' + (Object.keys(allProps).length - 10) + ' more\n';
      break;
    }
  }

  if (count === 0) {
    message += '(No properties found)';
  }

  ui.alert('User Properties', message, ui.ButtonSet.OK);
}

/**
 * Manually clear specific cache keys
 */
function manualCacheClear() {
  var ui = SpreadsheetApp.getUi();

  var response = ui.prompt(
    'Manual Cache Clear',
    'Enter a Message ID to clear from cache (or "all" to try clearing all):',
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() !== ui.Button.OK) {
    return;
  }

  var input = response.getResponseText();
  var cache = CacheService.getUserCache();

  if (input.toLowerCase() === 'all') {
    // Try to clear all possible keys
    var cleared = 0;

    // Try V1 keys
    var props = PropertiesService.getUserProperties();
    var oldProcessed = JSON.parse(props.getProperty('PROCESSED_MESSAGES') || '[]');
    oldProcessed.forEach(function(item) {
      try {
        cache.remove('processed_' + item.id);
        cleared++;
      } catch (e) {}
    });

    // Try V2 keys
    var v2Keys = JSON.parse(props.getProperty('CACHE_KEYS_V2') || '[]');
    v2Keys.forEach(function(key) {
      try {
        cache.remove(key);
        cleared++;
      } catch (e) {}
    });

    ui.alert('Cache Clear', 'Attempted to clear ' + cleared + ' cache keys', ui.ButtonSet.OK);
  } else {
    // Clear specific message ID
    cache.remove('processed_' + input);
    cache.remove('processed_v2_' + input);
    ui.alert('Cache Clear', 'Cleared cache for message ID: ' + input, ui.ButtonSet.OK);
  }
}

/**
 * Find emails that should be processed but aren't
 */
function findMissingEmails() {
  var ui = SpreadsheetApp.getUi();
  var config = getConfig();

  SpreadsheetApp.getActiveSpreadsheet().toast('Searching for emails...', 'SaveMe', 10);

  // Search for ALL emails with attachments in date range
  var query = 'has:attachment newer_than:' + config.daysBack + 'd';
  var threads = GmailApp.search(query, 0, 10);

  var results = 'üîç EMAILS WITH ATTACHMENTS (Last ' + config.daysBack + ' days)\n\n';
  results += 'Found ' + threads.length + ' threads\n\n';

  var processed = 0;
  var notProcessed = 0;
  var noAttachments = 0;

  for (var i = 0; i < Math.min(5, threads.length); i++) {
    var message = threads[i].getMessages()[0];
    var messageId = message.getId();

    results += (i + 1) + '. ' + message.getSubject() + '\n';
    results += '   From: ' + message.getFrom() + '\n';
    results += '   Date: ' + message.getDate() + '\n';

    var attachments = message.getAttachments();
    var largeAttachments = 0;
    for (var j = 0; j < attachments.length; j++) {
      if (attachments[j].getSize() >= config.minAttachmentSizeKB * 1024) {
        largeAttachments++;
      }
    }

    results += '   Attachments: ' + attachments.length + ' total, ' + largeAttachments + ' > ' + config.minAttachmentSizeKB + 'KB\n';

    if (isEmailProcessed(messageId) || isEmailInSheet(messageId)) {
      results += '   Status: ‚úÖ Already processed\n\n';
      processed++;
    } else if (largeAttachments === 0) {
      results += '   Status: ‚ö†Ô∏è No large attachments\n\n';
      noAttachments++;
    } else {
      results += '   Status: ‚ùå NOT PROCESSED (should be!)\n\n';
      notProcessed++;
    }
  }

  results += '\nSUMMARY:\n';
  results += '- Already processed: ' + processed + '\n';
  results += '- Not processed (should be): ' + notProcessed + '\n';
  results += '- No large attachments: ' + noAttachments;

  ui.alert('Missing Emails Analysis', results, ui.ButtonSet.OK);
}

/**
 * Reset EVERYTHING - the most aggressive clear possible
 */
function absoluteReset() {
  var ui = SpreadsheetApp.getUi();

  var response = ui.alert(
    '‚ò¢Ô∏è ABSOLUTE RESET',
    'This will:\n' +
    '1. Delete ALL user properties (including config)\n' +
    '2. Clear the sheet\n' +
    '3. Try to clear all cache\n\n' +
    'You will need to reconfigure settings after this.\n\n' +
    'Are you ABSOLUTELY sure?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    return;
  }

  try {
    // Clear sheet
    var sheet = getCurrentSheet();
    sheet.clear();

    // Delete ALL properties
    PropertiesService.getUserProperties().deleteAllProperties();

    // Try to clear cache (best effort)
    var cache = CacheService.getUserCache();
    try {
      // We can't enumerate keys, but we can try common patterns
      for (var i = 0; i < 1000; i++) {
        try {
          cache.remove('processed_' + i);
          cache.remove('processed_v2_' + i);
        } catch (e) {}
      }
    } catch (e) {}

    ui.alert('Complete!',
      '‚úÖ Absolute reset complete!\n\n' +
      '‚ö†Ô∏è You must now:\n' +
      '1. Configure Settings (API key, Drive folder)\n' +
      '2. Set your preferences\n' +
      '3. Process emails fresh\n\n' +
      'Everything has been completely reset.',
      ui.ButtonSet.OK);

  } catch (e) {
    ui.alert('Error', 'Reset failed: ' + e.message, ui.ButtonSet.OK);
  }
}
===== END OF DebugManager.gs =====


================================================================================
FILE: SettingsPanel.html
TYPE: HTML
ACTION: In Apps Script, click '+ ‚Üí HTML', name it 'SettingsPanel', paste content below
================================================================================

===== START OF SettingsPanel.html =====
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background: #f5f5f5;
      color: #333;
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    h1 {
      color: #1a73e8;
      margin-bottom: 10px;
      font-size: 24px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .section {
      margin-bottom: 30px;
      padding-bottom: 30px;
      border-bottom: 1px solid #e0e0e0;
    }

    .section:last-of-type {
      border-bottom: none;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
    }

    .section-title::before {
      content: '';
      display: inline-block;
      width: 4px;
      height: 20px;
      background: #1a73e8;
      margin-right: 10px;
      border-radius: 2px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 500;
      margin-bottom: 8px;
      font-size: 14px;
      color: #555;
    }

    input[type="text"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .checkbox-group {
      display: flex;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    input[type="checkbox"] {
      margin-right: 10px;
      margin-top: 3px;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .checkbox-label {
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      user-select: none;
    }

    .help-text {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
      line-height: 1.4;
    }

    .template-hint {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      font-size: 12px;
      color: #666;
      margin-top: 8px;
      line-height: 1.5;
    }

    .template-hint code {
      background: #e8eaed;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid #e0e0e0;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #1a73e8;
      color: white;
      flex: 1;
    }

    .btn-primary:hover {
      background: #1557b0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .btn-secondary {
      background: #f1f3f4;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e8eaed;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #1a73e8;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    @media (max-width: 600px) {
      .row {
        grid-template-columns: 1fr;
      }
    }

    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 20px;
      display: none;
    }

    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 20px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>‚öôÔ∏è SaveMe Configuration</h1>
    <p class="subtitle">Configure all settings in one place</p>

    <div class="success-message" id="successMessage"></div>
    <div class="error-message" id="errorMessage"></div>

    <!-- Google Drive Configuration -->
    <div class="section">
      <div class="section-title">üìÅ Google Drive</div>

      <div class="form-group">
        <label for="folderId">Drive Folder *</label>
        <input type="text" id="folderId" placeholder="Paste folder URL or ID here">
        <div class="help-text">Right-click your Drive folder ‚Üí Get link ‚Üí Paste the entire URL here. All emails and attachments will be saved here.</div>
      </div>
    </div>

    <!-- What to Save -->
    <div class="section">
      <div class="section-title">üíæ What to Save</div>

      <div class="checkbox-group">
        <input type="checkbox" id="saveEmailBody">
        <label for="saveEmailBody" class="checkbox-label">
          Save Email Messages as individual files
          <div class="help-text">Save the email body as PDF, HTML, or plain text</div>
        </label>
      </div>

      <div class="form-group" id="emailFormatGroup" style="margin-left: 28px; display: none;">
        <label for="emailFormat">Email Format</label>
        <select id="emailFormat">
          <option value="pdf">PDF (recommended)</option>
          <option value="html">HTML</option>
          <option value="txt">Plain Text</option>
          <option value="all">All formats</option>
        </select>
      </div>

      <div class="checkbox-group">
        <input type="checkbox" id="saveAttachments" checked>
        <label for="saveAttachments" class="checkbox-label">
          Save Email Attachments as files
          <div class="help-text">Save all attachments to Google Drive</div>
        </label>
      </div>
    </div>

    <!-- File Naming -->
    <div class="section">
      <div class="section-title">üìù File Naming & Organization</div>

      <div class="form-group">
        <label for="fileNamingTemplate">Attachment File Name Template</label>
        <input type="text" id="fileNamingTemplate" value="{{Year}}.{{Month}}.{{Day}}-{{AttachmentName}}">
        <div class="template-hint">
          <strong>Available variables:</strong><br>
          <code>{{Year}}</code> <code>{{Month}}</code> <code>{{Day}}</code> <code>{{Date}}</code><br>
          <code>{{Sender}}</code> <code>{{SenderEmail}}</code> <code>{{Subject}}</code><br>
          <code>{{AttachmentName}}</code> <code>{{OriginalName}}</code>
        </div>
      </div>

      <div class="form-group">
        <label for="emailNamingTemplate">Email Body File Name Template</label>
        <input type="text" id="emailNamingTemplate" value="{{Year}}-{{Month}}-{{Day}}_{{Subject}}">
        <div class="help-text">Only applies if "Save Email Messages" is enabled</div>
      </div>
    </div>

    <!-- File Filtering -->
    <div class="section">
      <div class="section-title">üîç File Filtering</div>

      <div class="row">
        <div class="form-group">
          <label for="minAttachmentSize">Minimum Attachment Size (KB)</label>
          <input type="number" id="minAttachmentSize" value="5" min="0" max="100">
          <div class="help-text">Skip files smaller than this (e.g., inline images)</div>
        </div>

        <div class="form-group">
          <label for="maxAttachmentSize">Maximum Attachment Size (MB)</label>
          <input type="number" id="maxAttachmentSize" value="0" min="0" max="100">
          <div class="help-text">0 = no limit</div>
        </div>
      </div>

      <div class="form-group">
        <label for="allowedExtensions">Allowed File Extensions (optional)</label>
        <input type="text" id="allowedExtensions" placeholder="pdf, docx, xlsx, jpg, png">
        <div class="help-text">Leave blank to allow all. Comma-separated list.</div>
      </div>

      <div class="form-group">
        <label for="disallowedExtensions">Disallowed File Extensions (optional)</label>
        <input type="text" id="disallowedExtensions" placeholder="exe, zip, dmg">
        <div class="help-text">Block specific file types. Comma-separated list.</div>
      </div>
    </div>

    <!-- AI Settings -->
    <div class="section">
      <div class="section-title">ü§ñ AI Summarization</div>

      <div class="checkbox-group">
        <input type="checkbox" id="enableAI" checked>
        <label for="enableAI" class="checkbox-label">
          Enable AI-powered email summaries
          <div class="help-text">Uses OpenRouter.ai to generate intelligent summaries of email content</div>
        </label>
      </div>

      <div id="aiSettingsGroup">
        <div class="form-group">
          <label for="apiKey">OpenRouter API Key *</label>
          <input type="text" id="apiKey" placeholder="sk-or-v1-...">
          <div class="help-text">Get your API key from <a href="https://openrouter.ai/keys" target="_blank">openrouter.ai/keys</a> (only needed when AI is enabled)</div>
        </div>

        <div class="form-group">
          <label for="aiModel">AI Model</label>
          <select id="aiModel">
            <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet (Best quality, ~$3/1M tokens)</option>
            <option value="anthropic/claude-3-haiku">Claude 3 Haiku (Fast & cheap, ~$0.25/1M tokens)</option>
            <option value="anthropic/claude-3-opus">Claude 3 Opus (Highest quality, ~$15/1M tokens)</option>
            <option value="openai/gpt-4-turbo">GPT-4 Turbo (High quality, ~$10/1M tokens)</option>
            <option value="openai/gpt-3.5-turbo">GPT-3.5 Turbo (Cheap, ~$0.50/1M tokens)</option>
            <option value="google/gemini-pro">Gemini Pro (Free tier available)</option>
            <option value="meta-llama/llama-3-70b-instruct">Llama 3 70B (~$0.70/1M tokens)</option>
            <option value="mistralai/mistral-7b-instruct">Mistral 7B (Very cheap, ~$0.10/1M tokens)</option>
          </select>
          <div class="help-text">Choose the AI model for generating email summaries</div>
        </div>

        <div class="form-group">
          <label for="aiPrompt">AI Summary Prompt</label>
          <textarea id="aiPrompt">Summarize this email in 5-10 words, focusing on the main action or topic:</textarea>
          <div class="help-text">What should the AI answer about each email?</div>
        </div>

        <div class="form-group">
          <label for="maxTokens">Max Response Tokens</label>
          <input type="number" id="maxTokens" value="100" min="20" max="500">
          <div class="help-text">Longer = more detailed but more expensive</div>
        </div>
      </div>
    </div>

    <!-- Processing Settings -->
    <div class="section">
      <div class="section-title">‚ö° Processing Settings</div>

      <div class="row">
        <div class="form-group">
          <label for="batchSize">Batch Size (emails per run)</label>
          <input type="number" id="batchSize" value="10" min="1" max="50">
          <div class="help-text">How many emails to process at once</div>
        </div>

        <div class="form-group">
          <label for="daysBack">Search Range (days back)</label>
          <input type="number" id="daysBack" value="7" min="1" max="365">
          <div class="help-text">How far back to search for emails</div>
        </div>
      </div>

      <div class="form-group">
        <label for="emailFilter">Gmail Search Filter (optional)</label>
        <input type="text" id="emailFilter" placeholder="has:attachment from:example@company.com">
        <div class="help-text">Use Gmail search syntax. Leave blank for default: has:attachment</div>
      </div>

      <div class="checkbox-group">
        <input type="checkbox" id="newestFirst" checked>
        <label for="newestFirst" class="checkbox-label">
          Process newest emails first
          <div class="help-text">Unchecked = oldest first</div>
        </label>
      </div>
    </div>

    <!-- Buttons -->
    <div class="button-group">
      <button type="button" class="btn-secondary" onclick="closePanel()">Cancel</button>
      <button type="button" class="btn-primary" onclick="saveSettings()">üíæ Save Configuration</button>
    </div>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div>Saving configuration...</div>
    </div>
  </div>

  <script>
    // Load current configuration when panel opens
    window.onload = function() {
      google.script.run
        .withSuccessHandler(loadConfig)
        .withFailureHandler(showError)
        .getConfig();
    };

    function loadConfig(config) {
      // API & Auth
      document.getElementById('apiKey').value = config.apiKey || '';
      document.getElementById('folderId').value = config.folderId || '';

      // What to Save
      document.getElementById('saveEmailBody').checked = config.saveEmailBody || false;
      document.getElementById('emailFormat').value = config.emailFormat || 'pdf';
      document.getElementById('saveAttachments').checked = config.saveAttachments !== false;

      // File Naming
      document.getElementById('fileNamingTemplate').value = config.fileNamingTemplate || '{{Year}}.{{Month}}.{{Day}}-{{AttachmentName}}';
      document.getElementById('emailNamingTemplate').value = config.emailNamingTemplate || '{{Year}}-{{Month}}-{{Day}}_{{Subject}}';

      // File Filtering
      document.getElementById('minAttachmentSize').value = config.minAttachmentSizeKB || 5;
      document.getElementById('maxAttachmentSize').value = config.maxAttachmentSizeMB || 0;
      document.getElementById('allowedExtensions').value = config.allowedExtensions || '';
      document.getElementById('disallowedExtensions').value = config.disallowedExtensions || '';

      // AI Settings
      document.getElementById('enableAI').checked = config.enableAI !== false; // Default true
      document.getElementById('aiModel').value = config.model || 'anthropic/claude-3.5-sonnet';
      document.getElementById('aiPrompt').value = config.summaryPrompt || 'Summarize this email in 5-10 words, focusing on the main action or topic:';
      document.getElementById('maxTokens').value = config.maxTokens || 100;

      // Processing
      document.getElementById('batchSize').value = config.batchSize || 10;
      document.getElementById('daysBack').value = config.daysBack || 7;
      document.getElementById('emailFilter').value = config.emailFilter || '';
      document.getElementById('newestFirst').checked = config.newestFirst !== false;

      // Toggle visibility based on checkboxes
      toggleEmailFormatGroup();
      toggleAISettingsGroup();
    }

    function saveSettings() {
      // Validate required fields
      const apiKey = document.getElementById('apiKey').value.trim();
      const folderId = document.getElementById('folderId').value.trim();
      const enableAI = document.getElementById('enableAI').checked;

      // API key is only required if AI is enabled
      if (enableAI && !apiKey) {
        showError('OpenRouter API Key is required when AI summarization is enabled');
        return;
      }

      if (!folderId) {
        showError('Google Drive Folder is required');
        return;
      }

      // Collect all settings
      const settings = {
        // API & Auth
        apiKey: apiKey,
        folderId: folderId,

        // What to Save
        saveEmailBody: document.getElementById('saveEmailBody').checked,
        emailFormat: document.getElementById('emailFormat').value,
        saveAttachments: document.getElementById('saveAttachments').checked,

        // File Naming
        fileNamingTemplate: document.getElementById('fileNamingTemplate').value,
        emailNamingTemplate: document.getElementById('emailNamingTemplate').value,

        // File Filtering
        minAttachmentSizeKB: parseInt(document.getElementById('minAttachmentSize').value),
        maxAttachmentSizeMB: parseInt(document.getElementById('maxAttachmentSize').value),
        allowedExtensions: document.getElementById('allowedExtensions').value,
        disallowedExtensions: document.getElementById('disallowedExtensions').value,

        // AI Settings
        enableAI: enableAI,
        model: document.getElementById('aiModel').value,
        summaryPrompt: document.getElementById('aiPrompt').value,
        maxTokens: parseInt(document.getElementById('maxTokens').value),

        // Processing
        batchSize: parseInt(document.getElementById('batchSize').value),
        daysBack: parseInt(document.getElementById('daysBack').value),
        emailFilter: document.getElementById('emailFilter').value,
        newestFirst: document.getElementById('newestFirst').checked
      };

      // Show loading
      document.getElementById('loading').style.display = 'block';
      document.querySelector('.button-group').style.display = 'none';

      // Save to backend
      google.script.run
        .withSuccessHandler(onSaveSuccess)
        .withFailureHandler(onSaveError)
        .saveAllSettings(settings);
    }

    function onSaveSuccess() {
      document.getElementById('loading').style.display = 'none';
      showSuccess('‚úÖ Configuration saved successfully!');

      // Close panel after 2 seconds
      setTimeout(function() {
        google.script.host.close();
      }, 2000);
    }

    function onSaveError(error) {
      document.getElementById('loading').style.display = 'none';
      document.querySelector('.button-group').style.display = 'flex';
      showError('Error saving configuration: ' + error.message);
    }

    function showSuccess(message) {
      const el = document.getElementById('successMessage');
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(function() {
        el.style.display = 'none';
      }, 5000);
    }

    function showError(message) {
      const el = document.getElementById('errorMessage');
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(function() {
        el.style.display = 'none';
      }, 5000);
    }

    function closePanel() {
      google.script.host.close();
    }

    // Toggle email format dropdown visibility
    document.getElementById('saveEmailBody').addEventListener('change', toggleEmailFormatGroup);

    function toggleEmailFormatGroup() {
      const saveEmailBody = document.getElementById('saveEmailBody').checked;
      document.getElementById('emailFormatGroup').style.display = saveEmailBody ? 'block' : 'none';
    }

    // Toggle AI settings visibility
    document.getElementById('enableAI').addEventListener('change', toggleAISettingsGroup);

    function toggleAISettingsGroup() {
      const enableAI = document.getElementById('enableAI').checked;
      document.getElementById('aiSettingsGroup').style.display = enableAI ? 'block' : 'none';
    }
  </script>
</body>
</html>

===== END OF SettingsPanel.html =====


================================================================================
FILE: appsscript.json
TYPE: Manifest
ACTION: 
  1. Go to Project Settings (‚öôÔ∏è icon)
  2. Check ‚úÖ 'Show appsscript.json manifest file in editor'
  3. Go back to Editor, click 'appsscript.json'
  4. Replace ENTIRE content with code below
================================================================================

===== START OF appsscript.json =====
{
  "timeZone": "America/New_York",
  "dependencies": {},
  "exceptionLogging": "STACKDRIVER",
  "runtimeVersion": "V8",
  "oauthScopes": [
    "https://www.googleapis.com/auth/gmail.readonly",
    "https://www.googleapis.com/auth/drive",
    "https://www.googleapis.com/auth/spreadsheets.currentonly",
    "https://www.googleapis.com/auth/script.external_request",
    "https://www.googleapis.com/auth/script.container.ui"
  ]
}

===== END OF appsscript.json =====


================================================================================
DEPLOYMENT COMPLETE!
================================================================================

Next steps:
1. Save the Apps Script project (üíæ or Cmd/S)
2. Close Apps Script editor
3. Refresh the Google Sheet (F5)
4. Wait for SaveMe menu to appear
5. Click SaveMe ‚Üí Configure Settings
6. Authorize the app
7. Configure settings and test

For detailed instructions, see: TESTING_GUIDE.md

================================================================================
